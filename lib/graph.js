'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var necessary = require('necessary');

var Cycle = require('./graph/cycle'),
    Stack = require('./graph/stack'),
    Vertex = require('./graph/vertex'),
    StronglyConnectedComponent = require('./graph/stronglyConnectedComponent');

var arrayUtilities = necessary.arrayUtilities,
    first = arrayUtilities.first,
    second = arrayUtilities.second;

var Graph = function () {
  function Graph(vertices, stronglyConnectedComponents, cycles) {
    _classCallCheck(this, Graph);

    this.vertices = vertices;
    this.stronglyConnectedComponents = stronglyConnectedComponents;
    this.cycles = cycles;
  }

  _createClass(Graph, [{
    key: 'getVertices',
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: 'getStronglyConnectedComponents',
    value: function getStronglyConnectedComponents() {
      return this.stronglyConnectedComponents;
    }
  }, {
    key: 'getCycles',
    value: function getCycles() {
      return this.cycles;
    }
  }, {
    key: 'isVertexPresent',
    value: function isVertexPresent(name) {
      var vertexPresent = this.vertices.some(function (vertex) {
        var vertexName = vertex.getName();

        if (vertexName === name) {
          return true;
        }
      });

      return vertexPresent;
    }
  }], [{
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexLiterals.reduce(function (vertexMap, vertexLiteral) {
        addVertexLiteral(vertexMap, vertexLiteral);

        return vertexMap;
      }, {}),
          vertices = verticesFromVertexMap(vertexMap),
          stronglyConnectedComponents = stronglyConnectedComponentsFromVertices(vertices),
          cycles = cyclesFromStronglyConnectedComponents(stronglyConnectedComponents),
          graph = new Graph(vertices, stronglyConnectedComponents, cycles);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function addVertexLiteral(vertexMap, vertexLiteral) {
  var firstVertexLiteralElement = first(vertexLiteral),
      secondVertexLiteralElement = second(vertexLiteral),
      vertexName = firstVertexLiteralElement,
      ///
  descendantVertexNames = secondVertexLiteralElement; ///

  var successorVertices = descendantVertexNames.map(function (descendantVertexName) {
    var successorVertex = void 0;

    var successorVertexName = descendantVertexName,
        ///
    successorVertexExists = vertexMap.hasOwnProperty(successorVertexName);

    if (successorVertexExists) {
      successorVertex = vertexMap[successorVertexName];
    } else {
      successorVertex = Vertex.fromVertexName(successorVertexName);

      vertexMap[successorVertexName] = successorVertex;
    }

    return successorVertex;
  });

  var vertex = void 0;

  var vertexExists = vertexMap.hasOwnProperty(vertexName);

  if (vertexExists) {
    vertex = vertexMap[vertexName];
  } else {
    vertex = Vertex.fromVertexName(vertexName);

    vertexMap[vertexName] = vertex;
  }

  successorVertices = successorVertices.concat([]).reverse(); ///

  vertex.setSuccessorVertices(successorVertices);
}

function verticesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      vertices = vertexNames.map(function (vertexName) {
    var vertex = vertexMap[vertexName];

    return vertex;
  });

  return vertices;
}

function stronglyConnectedComponentsFromVertices(vertices) {
  var stack = new Stack(),
      stronglyConnectedComponents = [];

  var index = 0;

  function stronglyConnectVertex(vertex) {
    var lowestIndex = index; ///

    vertex.setIndex(index);

    vertex.setLowestIndex(lowestIndex);

    index++;

    stack.push(vertex);

    var successorVertices = vertex.getSuccessorVertices();

    successorVertices.forEach(function (successorVertex) {
      var successorVertexUnindexed = successorVertex.isUnindexed(),
          successorVertexNotStronglyConnected = successorVertexUnindexed; ///

      if (successorVertexNotStronglyConnected) {
        stronglyConnectVertex(successorVertex);

        var successorVertexLowestIndex = successorVertex.getLowestIndex();

        vertex.updateLowestIndex(successorVertexLowestIndex);
      } else {
        var successorVertexStacked = successorVertex.isStacked();

        if (successorVertexStacked) {
          var successorVertexIndex = successorVertex.getIndex();

          vertex.updateLowestIndex(successorVertexIndex);
        }
      }
    });

    var vertexLowest = vertex.isLowest();

    if (vertexLowest) {
      var stronglyConnectedComponent = StronglyConnectedComponent.fromStackAndVertex(stack, vertex);

      stronglyConnectedComponents.push(stronglyConnectedComponent);
    }
  }

  vertices.forEach(function (vertex) {
    var vertexUnindexed = vertex.isUnindexed();

    if (vertexUnindexed) {
      stronglyConnectVertex(vertex);
    }
  });

  return stronglyConnectedComponents;
}

function cyclesFromStronglyConnectedComponents(stronglyConnectedComponents) {
  var cycles = stronglyConnectedComponents.reduce(function (cycles, stronglyConnectedComponent) {
    var stronglyConnectedComponentCyclic = stronglyConnectedComponent.isCyclic();

    if (stronglyConnectedComponentCyclic) {
      var cycle = Cycle.fromStronglyConnectedComponent(stronglyConnectedComponent);

      cycles.push(cycle);
    }

    return cycles;
  }, []);

  return cycles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJuZWNlc3NhcnkiLCJyZXF1aXJlIiwiQ3ljbGUiLCJTdGFjayIsIlZlcnRleCIsIlN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiYXJyYXlVdGlsaXRpZXMiLCJmaXJzdCIsInNlY29uZCIsIkdyYXBoIiwidmVydGljZXMiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMiLCJjeWNsZXMiLCJuYW1lIiwidmVydGV4UHJlc2VudCIsInNvbWUiLCJ2ZXJ0ZXgiLCJ2ZXJ0ZXhOYW1lIiwiZ2V0TmFtZSIsInZlcnRleExpdGVyYWxzIiwidmVydGV4TWFwIiwicmVkdWNlIiwidmVydGV4TGl0ZXJhbCIsImFkZFZlcnRleExpdGVyYWwiLCJ2ZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHNGcm9tVmVydGljZXMiLCJjeWNsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzIiwiZ3JhcGgiLCJtb2R1bGUiLCJleHBvcnRzIiwiZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCIsInNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50IiwiZGVzY2VuZGFudFZlcnRleE5hbWVzIiwic3VjY2Vzc29yVmVydGljZXMiLCJtYXAiLCJkZXNjZW5kYW50VmVydGV4TmFtZSIsInN1Y2Nlc3NvclZlcnRleCIsInN1Y2Nlc3NvclZlcnRleE5hbWUiLCJzdWNjZXNzb3JWZXJ0ZXhFeGlzdHMiLCJoYXNPd25Qcm9wZXJ0eSIsImZyb21WZXJ0ZXhOYW1lIiwidmVydGV4RXhpc3RzIiwiY29uY2F0IiwicmV2ZXJzZSIsInNldFN1Y2Nlc3NvclZlcnRpY2VzIiwidmVydGV4TmFtZXMiLCJPYmplY3QiLCJrZXlzIiwic3RhY2siLCJpbmRleCIsInN0cm9uZ2x5Q29ubmVjdFZlcnRleCIsImxvd2VzdEluZGV4Iiwic2V0SW5kZXgiLCJzZXRMb3dlc3RJbmRleCIsInB1c2giLCJnZXRTdWNjZXNzb3JWZXJ0aWNlcyIsImZvckVhY2giLCJzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQiLCJpc1VuaW5kZXhlZCIsInN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkIiwic3VjY2Vzc29yVmVydGV4TG93ZXN0SW5kZXgiLCJnZXRMb3dlc3RJbmRleCIsInVwZGF0ZUxvd2VzdEluZGV4Iiwic3VjY2Vzc29yVmVydGV4U3RhY2tlZCIsImlzU3RhY2tlZCIsInN1Y2Nlc3NvclZlcnRleEluZGV4IiwiZ2V0SW5kZXgiLCJ2ZXJ0ZXhMb3dlc3QiLCJpc0xvd2VzdCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiZnJvbVN0YWNrQW5kVmVydGV4IiwidmVydGV4VW5pbmRleGVkIiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRDeWNsaWMiLCJpc0N5Y2xpYyIsImN5Y2xlIiwiZnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsWUFBWUMsUUFBUSxXQUFSLENBQWxCOztBQUVBLElBQU1DLFFBQVFELFFBQVEsZUFBUixDQUFkO0FBQUEsSUFDTUUsUUFBUUYsUUFBUSxlQUFSLENBRGQ7QUFBQSxJQUVNRyxTQUFTSCxRQUFRLGdCQUFSLENBRmY7QUFBQSxJQUdNSSw2QkFBNkJKLFFBQVEsb0NBQVIsQ0FIbkM7O0FBS00sSUFBRUssY0FBRixHQUFxQk4sU0FBckIsQ0FBRU0sY0FBRjtBQUFBLElBQ0VDLEtBREYsR0FDb0JELGNBRHBCLENBQ0VDLEtBREY7QUFBQSxJQUNTQyxNQURULEdBQ29CRixjQURwQixDQUNTRSxNQURUOztJQUdBQyxLO0FBQ0osaUJBQWFDLFFBQWIsRUFBdUJDLDJCQUF2QixFQUFvREMsTUFBcEQsRUFBNEQ7QUFBQTs7QUFDMUQsU0FBS0YsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQywyQkFBTCxHQUFtQ0EsMkJBQW5DO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBQ0Q7Ozs7a0NBRWE7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QUFxRGhDLE1BQXJELENBQW5DOztBQUVBTCxrQ0FBNEIyQyxJQUE1QixDQUFpQ2UsMEJBQWpDO0FBQ0Q7QUFDRjs7QUFFRDNELFdBQVM4QyxPQUFULENBQWlCLFVBQVN4QyxNQUFULEVBQWlCO0FBQ2hDLFFBQU11RCxrQkFBa0J2RCxPQUFPMEMsV0FBUCxFQUF4Qjs7QUFFQSxRQUFJYSxlQUFKLEVBQXFCO0FBQ25CckIsNEJBQXNCbEMsTUFBdEI7QUFDRDtBQUNGLEdBTkQ7O0FBUUEsU0FBT0wsMkJBQVA7QUFDRDs7QUFFRCxTQUFTZSxxQ0FBVCxDQUErQ2YsMkJBQS9DLEVBQTRFO0FBQzFFLE1BQU1DLFNBQVNELDRCQUE0QlUsTUFBNUIsQ0FBbUMsVUFBU1QsTUFBVCxFQUFpQnlELDBCQUFqQixFQUE2QztBQUM3RixRQUFNRyxtQ0FBbUNILDJCQUEyQkksUUFBM0IsRUFBekM7O0FBRUEsUUFBSUQsZ0NBQUosRUFBc0M7QUFDcEMsVUFBTUUsUUFBUXhFLE1BQU15RSw4QkFBTixDQUFxQ04sMEJBQXJDLENBQWQ7O0FBRUF6RCxhQUFPMEMsSUFBUCxDQUFZb0IsS0FBWjtBQUNEOztBQUVELFdBQU85RCxNQUFQO0FBQ0QsR0FWYyxFQVVaLEVBVlksQ0FBZjs7QUFZQSxTQUFPQSxNQUFQO0FBQ0QiLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBDeWNsZSA9IHJlcXVpcmUoJy4vZ3JhcGgvY3ljbGUnKSxcbiAgICAgIFN0YWNrID0gcmVxdWlyZSgnLi9ncmFwaC9zdGFjaycpLFxuICAgICAgVmVydGV4ID0gcmVxdWlyZSgnLi9ncmFwaC92ZXJ0ZXgnKSxcbiAgICAgIFN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50ID0gcmVxdWlyZSgnLi9ncmFwaC9zdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCcpO1xuXG5jb25zdCB7IGFycmF5VXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpcnN0LCBzZWNvbmQgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5jbGFzcyBHcmFwaCB7XG4gIGNvbnN0cnVjdG9yICh2ZXJ0aWNlcywgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLCBjeWNsZXMpIHtcbiAgICB0aGlzLnZlcnRpY2VzID0gdmVydGljZXM7XG4gICAgdGhpcy5zdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHM7XG4gICAgdGhpcy5jeWNsZXMgPSBjeWNsZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNlcygpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJ0aWNlcztcbiAgfVxuXG4gIGdldFN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cygpIHtcbiAgICByZXR1cm4gdGhpcy5zdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHM7XG4gIH1cbiAgXG4gIGdldEN5Y2xlcygpIHtcbiAgICByZXR1cm4gdGhpcy5jeWNsZXM7XG4gIH1cbiAgXG4gIGlzVmVydGV4UHJlc2VudChuYW1lKSB7XG4gICAgY29uc3QgdmVydGV4UHJlc2VudCA9IHRoaXMudmVydGljZXMuc29tZShmdW5jdGlvbih2ZXJ0ZXgpIHtcbiAgICAgIGNvbnN0IHZlcnRleE5hbWUgPSB2ZXJ0ZXguZ2V0TmFtZSgpO1xuICAgICAgXG4gICAgICBpZiAodmVydGV4TmFtZSA9PT0gbmFtZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB2ZXJ0ZXhQcmVzZW50O1xuICB9XG5cbiAgc3RhdGljIGZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscykge1xuICAgIGNvbnN0IHZlcnRleE1hcCA9IHZlcnRleExpdGVyYWxzLnJlZHVjZShmdW5jdGlvbih2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpIHtcbiAgICAgICAgICAgIGFkZFZlcnRleExpdGVyYWwodmVydGV4TWFwLCB2ZXJ0ZXhMaXRlcmFsKTsgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHZlcnRleE1hcDtcbiAgICAgICAgICB9LCB7fSksXG4gICAgICAgICAgdmVydGljZXMgPSB2ZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSxcbiAgICAgICAgICBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHNGcm9tVmVydGljZXModmVydGljZXMpLFxuICAgICAgICAgIGN5Y2xlcyA9IGN5Y2xlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKSxcbiAgICAgICAgICBncmFwaCA9IG5ldyBHcmFwaCh2ZXJ0aWNlcywgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLCBjeWNsZXMpO1xuICAgIFxuICAgIHJldHVybiBncmFwaDtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEdyYXBoO1xuXG5mdW5jdGlvbiBhZGRWZXJ0ZXhMaXRlcmFsKHZlcnRleE1hcCwgdmVydGV4TGl0ZXJhbCkge1xuICBjb25zdCBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50ID0gZmlyc3QodmVydGV4TGl0ZXJhbCksXG4gICAgICAgIHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50ID0gc2Vjb25kKHZlcnRleExpdGVyYWwpLFxuICAgICAgICB2ZXJ0ZXhOYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICBsZXQgc3VjY2Vzc29yVmVydGljZXMgPSBkZXNjZW5kYW50VmVydGV4TmFtZXMubWFwKGZ1bmN0aW9uKGRlc2NlbmRhbnRWZXJ0ZXhOYW1lKSB7XG4gICAgbGV0IHN1Y2Nlc3NvclZlcnRleDtcblxuICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleE5hbWUgPSBkZXNjZW5kYW50VmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHN1Y2Nlc3NvclZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eShzdWNjZXNzb3JWZXJ0ZXhOYW1lKTtcblxuICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhFeGlzdHMpIHtcbiAgICAgIHN1Y2Nlc3NvclZlcnRleCA9IHZlcnRleE1hcFtzdWNjZXNzb3JWZXJ0ZXhOYW1lXTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3VjY2Vzc29yVmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHN1Y2Nlc3NvclZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbc3VjY2Vzc29yVmVydGV4TmFtZV0gPSBzdWNjZXNzb3JWZXJ0ZXg7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1Y2Nlc3NvclZlcnRleDtcbiAgfSk7XG5cbiAgbGV0IHZlcnRleDtcblxuICBjb25zdCB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkodmVydGV4TmFtZSk7XG5cbiAgaWYgKHZlcnRleEV4aXN0cykge1xuICAgIHZlcnRleCA9IHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXTtcbiAgfSBlbHNlIHtcbiAgICB2ZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUodmVydGV4TmFtZSk7XG5cbiAgICB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0gPSB2ZXJ0ZXg7XG4gIH1cblxuICBzdWNjZXNzb3JWZXJ0aWNlcyA9IHN1Y2Nlc3NvclZlcnRpY2VzLmNvbmNhdChbXSkucmV2ZXJzZSgpOyAvLy9cblxuICB2ZXJ0ZXguc2V0U3VjY2Vzc29yVmVydGljZXMoc3VjY2Vzc29yVmVydGljZXMpO1xufVxuXG5mdW5jdGlvbiB2ZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSB7XG4gIGNvbnN0IHZlcnRleE5hbWVzID0gT2JqZWN0LmtleXModmVydGV4TWFwKSxcbiAgICAgICAgdmVydGljZXMgPSB2ZXJ0ZXhOYW1lcy5tYXAoZnVuY3Rpb24odmVydGV4TmFtZSkge1xuICAgICAgICAgIGNvbnN0IHZlcnRleCA9IHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXTtcbiAgXG4gICAgICAgICAgcmV0dXJuIHZlcnRleDtcbiAgICAgICAgfSk7XG5cbiAgcmV0dXJuIHZlcnRpY2VzO1xufVxuXG5mdW5jdGlvbiBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHNGcm9tVmVydGljZXModmVydGljZXMpIHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKSxcbiAgICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gW107XG5cbiAgbGV0IGluZGV4ID0gMDtcblxuICBmdW5jdGlvbiBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgodmVydGV4KSB7XG4gICAgY29uc3QgbG93ZXN0SW5kZXggPSBpbmRleDsgIC8vL1xuXG4gICAgdmVydGV4LnNldEluZGV4KGluZGV4KTtcblxuICAgIHZlcnRleC5zZXRMb3dlc3RJbmRleChsb3dlc3RJbmRleCk7XG5cbiAgICBpbmRleCsrO1xuXG4gICAgc3RhY2sucHVzaCh2ZXJ0ZXgpO1xuXG4gICAgY29uc3Qgc3VjY2Vzc29yVmVydGljZXMgPSB2ZXJ0ZXguZ2V0U3VjY2Vzc29yVmVydGljZXMoKTtcblxuICAgIHN1Y2Nlc3NvclZlcnRpY2VzLmZvckVhY2goZnVuY3Rpb24oc3VjY2Vzc29yVmVydGV4KSB7XG4gICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQgPSBzdWNjZXNzb3JWZXJ0ZXguaXNVbmluZGV4ZWQoKSxcbiAgICAgICAgICAgIHN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkID0gc3VjY2Vzc29yVmVydGV4VW5pbmRleGVkOyAgLy8vXG5cbiAgICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhOb3RTdHJvbmdseUNvbm5lY3RlZCkge1xuICAgICAgICBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgoc3VjY2Vzc29yVmVydGV4KTtcblxuICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCA9IHN1Y2Nlc3NvclZlcnRleC5nZXRMb3dlc3RJbmRleCgpO1xuXG4gICAgICAgIHZlcnRleC51cGRhdGVMb3dlc3RJbmRleChzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkID0gc3VjY2Vzc29yVmVydGV4LmlzU3RhY2tlZCgpO1xuXG4gICAgICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkKSB7XG4gICAgICAgICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4SW5kZXggPSBzdWNjZXNzb3JWZXJ0ZXguZ2V0SW5kZXgoKTtcblxuICAgICAgICAgIHZlcnRleC51cGRhdGVMb3dlc3RJbmRleChzdWNjZXNzb3JWZXJ0ZXhJbmRleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHZlcnRleExvd2VzdCA9IHZlcnRleC5pc0xvd2VzdCgpO1xuXG4gICAgaWYgKHZlcnRleExvd2VzdCkge1xuICAgICAgY29uc3Qgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQgPSBTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5mcm9tU3RhY2tBbmRWZXJ0ZXgoc3RhY2ssIHZlcnRleCk7XG5cbiAgICAgIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cy5wdXNoKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICB2ZXJ0aWNlcy5mb3JFYWNoKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgIGNvbnN0IHZlcnRleFVuaW5kZXhlZCA9IHZlcnRleC5pc1VuaW5kZXhlZCgpO1xuXG4gICAgaWYgKHZlcnRleFVuaW5kZXhlZCkge1xuICAgICAgc3Ryb25nbHlDb25uZWN0VmVydGV4KHZlcnRleCk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzO1xufVxuXG5mdW5jdGlvbiBjeWNsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cykge1xuICBjb25zdCBjeWNsZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKGN5Y2xlcywgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQpIHtcbiAgICBjb25zdCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LmlzQ3ljbGljKCk7XG5cbiAgICBpZiAoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRDeWNsaWMpIHtcbiAgICAgIGNvbnN0IGN5Y2xlID0gQ3ljbGUuZnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KTtcblxuICAgICAgY3ljbGVzLnB1c2goY3ljbGUpO1xuICAgIH1cblxuICAgIHJldHVybiBjeWNsZXM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gY3ljbGVzO1xufVxuIl19