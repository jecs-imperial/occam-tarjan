"use strict";

var _necessary = require("necessary");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var Cycle = require("./graph/cycle"),
    Stack = require("./graph/stack"),
    Vertex = require("./graph/vertex"),
    StronglyConnectedComponent = require("./graph/stronglyConnectedComponent");

var first = _necessary.arrayUtilities.first,
    second = _necessary.arrayUtilities.second;

var Graph = /*#__PURE__*/function () {
  function Graph(stronglyConnectedComponents, vertices, cycles) {
    _classCallCheck(this, Graph);

    this.stronglyConnectedComponents = stronglyConnectedComponents;
    this.vertices = vertices;
    this.cycles = cycles;
  }

  _createClass(Graph, [{
    key: "getStronglyConnectedComponents",
    value: function getStronglyConnectedComponents() {
      return this.stronglyConnectedComponents;
    }
  }, {
    key: "getVertices",
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: "getCycles",
    value: function getCycles() {
      return this.cycles;
    }
  }, {
    key: "isVertexPresent",
    value: function isVertexPresent(name) {
      var vertexPresent = this.vertices.some(function (vertex) {
        var vertexName = vertex.getName();

        if (vertexName === name) {
          return true;
        }
      });
      return vertexPresent;
    }
  }], [{
    key: "fromVertexLiterals",
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexLiterals.reduce(function (vertexMap, vertexLiteral) {
        addVertexLiteral(vertexMap, vertexLiteral);
        return vertexMap;
      }, {}),
          vertices = verticesFromVertexMap(vertexMap),
          stronglyConnectedComponents = stronglyConnectedComponentsFromVertices(vertices),
          cycles = cyclesFromStronglyConnectedComponents(stronglyConnectedComponents),
          graph = new Graph(stronglyConnectedComponents, vertices, cycles);
      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function addVertexLiteral(vertexMap, vertexLiteral) {
  var firstVertexLiteralElement = first(vertexLiteral),
      secondVertexLiteralElement = second(vertexLiteral),
      vertexName = firstVertexLiteralElement,
      ///
  descendantVertexNames = secondVertexLiteralElement; ///

  var successorVertices = descendantVertexNames.map(function (descendantVertexName) {
    var successorVertex;
    var successorVertexName = descendantVertexName,
        ///
    successorVertexExists = vertexMap.hasOwnProperty(successorVertexName);

    if (successorVertexExists) {
      successorVertex = vertexMap[successorVertexName];
    } else {
      successorVertex = Vertex.fromVertexName(successorVertexName);
      vertexMap[successorVertexName] = successorVertex;
    }

    return successorVertex;
  });
  var vertex;
  var vertexExists = vertexMap.hasOwnProperty(vertexName);

  if (vertexExists) {
    vertex = vertexMap[vertexName];
  } else {
    vertex = Vertex.fromVertexName(vertexName);
    vertexMap[vertexName] = vertex;
  }

  successorVertices = successorVertices.concat([]).reverse(); ///

  vertex.setSuccessorVertices(successorVertices);
}

function verticesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      vertices = vertexNames.map(function (vertexName) {
    var vertex = vertexMap[vertexName];
    return vertex;
  });
  return vertices;
}

function stronglyConnectedComponentsFromVertices(vertices) {
  var stack = new Stack(),
      stronglyConnectedComponents = [];
  var index = 0;

  function stronglyConnectVertex(vertex) {
    var lowestIndex = index; ///

    vertex.setIndex(index);
    vertex.setLowestIndex(lowestIndex);
    index++;
    stack.push(vertex);
    var successorVertices = vertex.getSuccessorVertices();
    successorVertices.forEach(function (successorVertex) {
      var successorVertexUnindexed = successorVertex.isUnindexed(),
          successorVertexNotStronglyConnected = successorVertexUnindexed; ///

      if (successorVertexNotStronglyConnected) {
        stronglyConnectVertex(successorVertex);
        var successorVertexLowestIndex = successorVertex.getLowestIndex();
        vertex.updateLowestIndex(successorVertexLowestIndex);
      } else {
        var successorVertexStacked = successorVertex.isStacked();

        if (successorVertexStacked) {
          var successorVertexIndex = successorVertex.getIndex();
          vertex.updateLowestIndex(successorVertexIndex);
        }
      }
    });
    var vertexLowest = vertex.isLowest();

    if (vertexLowest) {
      var stronglyConnectedComponent = StronglyConnectedComponent.fromStackAndVertex(stack, vertex);
      stronglyConnectedComponents.push(stronglyConnectedComponent);
    }
  }

  vertices.forEach(function (vertex) {
    var vertexUnindexed = vertex.isUnindexed();

    if (vertexUnindexed) {
      stronglyConnectVertex(vertex);
    }
  });
  return stronglyConnectedComponents;
}

function cyclesFromStronglyConnectedComponents(stronglyConnectedComponents) {
  var cycles = stronglyConnectedComponents.reduce(function (cycles, stronglyConnectedComponent) {
    var stronglyConnectedComponentCyclic = stronglyConnectedComponent.isCyclic();

    if (stronglyConnectedComponentCyclic) {
      var cycle = Cycle.fromStronglyConnectedComponent(stronglyConnectedComponent);
      cycles.push(cycle);
    }

    return cycles;
  }, []);
  return cycles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoLmpzIl0sIm5hbWVzIjpbIkN5Y2xlIiwicmVxdWlyZSIsIlN0YWNrIiwiVmVydGV4IiwiU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJmaXJzdCIsImFycmF5VXRpbGl0aWVzIiwic2Vjb25kIiwiR3JhcGgiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMiLCJ2ZXJ0aWNlcyIsImN5Y2xlcyIsIm5hbWUiLCJ2ZXJ0ZXhQcmVzZW50Iiwic29tZSIsInZlcnRleCIsInZlcnRleE5hbWUiLCJnZXROYW1lIiwidmVydGV4TGl0ZXJhbHMiLCJ2ZXJ0ZXhNYXAiLCJyZWR1Y2UiLCJ2ZXJ0ZXhMaXRlcmFsIiwiYWRkVmVydGV4TGl0ZXJhbCIsInZlcnRpY2VzRnJvbVZlcnRleE1hcCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50c0Zyb21WZXJ0aWNlcyIsImN5Y2xlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMiLCJncmFwaCIsIm1vZHVsZSIsImV4cG9ydHMiLCJmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50Iiwic2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJzdWNjZXNzb3JWZXJ0aWNlcyIsIm1hcCIsImRlc2NlbmRhbnRWZXJ0ZXhOYW1lIiwic3VjY2Vzc29yVmVydGV4Iiwic3VjY2Vzc29yVmVydGV4TmFtZSIsInN1Y2Nlc3NvclZlcnRleEV4aXN0cyIsImhhc093blByb3BlcnR5IiwiZnJvbVZlcnRleE5hbWUiLCJ2ZXJ0ZXhFeGlzdHMiLCJjb25jYXQiLCJyZXZlcnNlIiwic2V0U3VjY2Vzc29yVmVydGljZXMiLCJ2ZXJ0ZXhOYW1lcyIsIk9iamVjdCIsImtleXMiLCJzdGFjayIsImluZGV4Iiwic3Ryb25nbHlDb25uZWN0VmVydGV4IiwibG93ZXN0SW5kZXgiLCJzZXRJbmRleCIsInNldExvd2VzdEluZGV4IiwicHVzaCIsImdldFN1Y2Nlc3NvclZlcnRpY2VzIiwiZm9yRWFjaCIsInN1Y2Nlc3NvclZlcnRleFVuaW5kZXhlZCIsImlzVW5pbmRleGVkIiwic3VjY2Vzc29yVmVydGV4Tm90U3Ryb25nbHlDb25uZWN0ZWQiLCJzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCIsImdldExvd2VzdEluZGV4IiwidXBkYXRlTG93ZXN0SW5kZXgiLCJzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkIiwiaXNTdGFja2VkIiwic3VjY2Vzc29yVmVydGV4SW5kZXgiLCJnZXRJbmRleCIsInZlcnRleExvd2VzdCIsImlzTG93ZXN0Iiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJmcm9tU3RhY2tBbmRWZXJ0ZXgiLCJ2ZXJ0ZXhVbmluZGV4ZWQiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYyIsImlzQ3ljbGljIiwiY3ljbGUiLCJmcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBOzs7Ozs7OztBQUVBLElBQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLGVBQUQsQ0FBckI7QUFBQSxJQUNNQyxLQUFLLEdBQUdELE9BQU8sQ0FBQyxlQUFELENBRHJCO0FBQUEsSUFFTUUsTUFBTSxHQUFHRixPQUFPLENBQUMsZ0JBQUQsQ0FGdEI7QUFBQSxJQUdNRywwQkFBMEIsR0FBR0gsT0FBTyxDQUFDLG9DQUFELENBSDFDOztJQUtRSSxLLEdBQWtCQyx5QixDQUFsQkQsSztJQUFPRSxNLEdBQVdELHlCLENBQVhDLE07O0lBRVRDLEs7QUFDSixpQkFBYUMsMkJBQWIsRUFBMENDLFFBQTFDLEVBQW9EQyxNQUFwRCxFQUE0RDtBQUFBOztBQUMxRCxTQUFLRiwyQkFBTCxHQUFtQ0EsMkJBQW5DO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFDRDs7OztxREFFZ0M7QUFDL0IsYUFBTyxLQUFLRiwyQkFBWjtBQUNEOzs7a0NBRWE7QUFDWixhQUFPLEtBQUtDLFFBQVo7QUFDRDs7O2dDQUVXO0FBQ1YsYUFBTyxLQUFLQyxNQUFaO0FBQ0Q7OztvQ0FFZUMsSSxFQUFNO0FBQ3BCLFVBQU1DLGFBQWEsR0FBRyxLQUFLSCxRQUFMLENBQWNJLElBQWQsQ0FBbUIsVUFBQ0MsTUFBRCxFQUFZO0FBQ25ELFlBQU1DLFVBQVUsR0FBR0QsTUFBTSxDQUFDRSxPQUFQLEVBQW5COztBQUVBLFlBQUlELFVBQVUsS0FBS0osSUFBbkIsRUFBeUI7QUFDdkIsaUJBQU8sSUFBUDtBQUNEO0FBQ0YsT0FOcUIsQ0FBdEI7QUFRQSxhQUFPQyxhQUFQO0FBQ0Q7Ozt1Q0FFeUJLLGMsRUFBZ0I7QUFDeEMsVUFBTUMsU0FBUyxHQUFHRCxjQUFjLENBQUNFLE1BQWYsQ0FBc0IsVUFBQ0QsU0FBRCxFQUFZRSxhQUFaLEVBQThCO0FBQzlEQyxRQUFBQSxnQkFBZ0IsQ0FBQ0gsU0FBRCxFQUFZRSxhQUFaLENBQWhCO0FBRUEsZUFBT0YsU0FBUDtBQUNELE9BSlcsRUFJVCxFQUpTLENBQWxCO0FBQUEsVUFLTVQsUUFBUSxHQUFHYSxxQkFBcUIsQ0FBQ0osU0FBRCxDQUx0QztBQUFBLFVBTU1WLDJCQUEyQixHQUFHZSx1Q0FBdUMsQ0FBQ2QsUUFBRCxDQU4zRTtBQUFBLFVBT01DLE1BQU0sR0FBR2MscUNBQXFDLENBQUNoQiwyQkFBRCxDQVBwRDtBQUFBLFVBUU1pQixLQUFLLEdBQUcsSUFBSWxCLEtBQUosQ0FBVUMsMkJBQVYsRUFBdUNDLFFBQXZDLEVBQWlEQyxNQUFqRCxDQVJkO0FBVUEsYUFBT2UsS0FBUDtBQUNEOzs7Ozs7QUFHSEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEIsS0FBakI7O0FBRUEsU0FBU2MsZ0JBQVQsQ0FBMEJILFNBQTFCLEVBQXFDRSxhQUFyQyxFQUFvRDtBQUNsRCxNQUFNUSx5QkFBeUIsR0FBR3hCLEtBQUssQ0FBQ2dCLGFBQUQsQ0FBdkM7QUFBQSxNQUNNUywwQkFBMEIsR0FBR3ZCLE1BQU0sQ0FBQ2MsYUFBRCxDQUR6QztBQUFBLE1BRU1MLFVBQVUsR0FBR2EseUJBRm5CO0FBQUEsTUFFOEM7QUFDeENFLEVBQUFBLHFCQUFxQixHQUFHRCwwQkFIOUIsQ0FEa0QsQ0FJUTs7QUFFMUQsTUFBSUUsaUJBQWlCLEdBQUdELHFCQUFxQixDQUFDRSxHQUF0QixDQUEwQixVQUFDQyxvQkFBRCxFQUEwQjtBQUMxRSxRQUFJQyxlQUFKO0FBRUEsUUFBTUMsbUJBQW1CLEdBQUdGLG9CQUE1QjtBQUFBLFFBQW1EO0FBQzdDRyxJQUFBQSxxQkFBcUIsR0FBR2xCLFNBQVMsQ0FBQ21CLGNBQVYsQ0FBeUJGLG1CQUF6QixDQUQ5Qjs7QUFHQSxRQUFJQyxxQkFBSixFQUEyQjtBQUN6QkYsTUFBQUEsZUFBZSxHQUFHaEIsU0FBUyxDQUFDaUIsbUJBQUQsQ0FBM0I7QUFDRCxLQUZELE1BRU87QUFDTEQsTUFBQUEsZUFBZSxHQUFHaEMsTUFBTSxDQUFDb0MsY0FBUCxDQUFzQkgsbUJBQXRCLENBQWxCO0FBRUFqQixNQUFBQSxTQUFTLENBQUNpQixtQkFBRCxDQUFULEdBQWlDRCxlQUFqQztBQUNEOztBQUVELFdBQU9BLGVBQVA7QUFDRCxHQWZ1QixDQUF4QjtBQWlCQSxNQUFJcEIsTUFBSjtBQUVBLE1BQU15QixZQUFZLEdBQUdyQixTQUFTLENBQUNtQixjQUFWLENBQXlCdEIsVUFBekIsQ0FBckI7O0FBRUEsTUFBSXdCLFlBQUosRUFBa0I7QUFDaEJ6QixJQUFBQSxNQUFNLEdBQUdJLFNBQVMsQ0FBQ0gsVUFBRCxDQUFsQjtBQUNELEdBRkQsTUFFTztBQUNMRCxJQUFBQSxNQUFNLEdBQUdaLE1BQU0sQ0FBQ29DLGNBQVAsQ0FBc0J2QixVQUF0QixDQUFUO0FBRUFHLElBQUFBLFNBQVMsQ0FBQ0gsVUFBRCxDQUFULEdBQXdCRCxNQUF4QjtBQUNEOztBQUVEaUIsRUFBQUEsaUJBQWlCLEdBQUdBLGlCQUFpQixDQUFDUyxNQUFsQixDQUF5QixFQUF6QixFQUE2QkMsT0FBN0IsRUFBcEIsQ0FuQ2tELENBbUNVOztBQUU1RDNCLEVBQUFBLE1BQU0sQ0FBQzRCLG9CQUFQLENBQTRCWCxpQkFBNUI7QUFDRDs7QUFFRCxTQUFTVCxxQkFBVCxDQUErQkosU0FBL0IsRUFBMEM7QUFDeEMsTUFBTXlCLFdBQVcsR0FBR0MsTUFBTSxDQUFDQyxJQUFQLENBQVkzQixTQUFaLENBQXBCO0FBQUEsTUFDTVQsUUFBUSxHQUFHa0MsV0FBVyxDQUFDWCxHQUFaLENBQWdCLFVBQUNqQixVQUFELEVBQWdCO0FBQ3pDLFFBQU1ELE1BQU0sR0FBR0ksU0FBUyxDQUFDSCxVQUFELENBQXhCO0FBRUEsV0FBT0QsTUFBUDtBQUNELEdBSlUsQ0FEakI7QUFPQSxTQUFPTCxRQUFQO0FBQ0Q7O0FBRUQsU0FBU2MsdUNBQVQsQ0FBaURkLFFBQWpELEVBQTJEO0FBQ3pELE1BQU1xQyxLQUFLLEdBQUcsSUFBSTdDLEtBQUosRUFBZDtBQUFBLE1BQ01PLDJCQUEyQixHQUFHLEVBRHBDO0FBR0EsTUFBSXVDLEtBQUssR0FBRyxDQUFaOztBQUVBLFdBQVNDLHFCQUFULENBQStCbEMsTUFBL0IsRUFBdUM7QUFDckMsUUFBTW1DLFdBQVcsR0FBR0YsS0FBcEIsQ0FEcUMsQ0FDVDs7QUFFNUJqQyxJQUFBQSxNQUFNLENBQUNvQyxRQUFQLENBQWdCSCxLQUFoQjtBQUVBakMsSUFBQUEsTUFBTSxDQUFDcUMsY0FBUCxDQUFzQkYsV0FBdEI7QUFFQUYsSUFBQUEsS0FBSztBQUVMRCxJQUFBQSxLQUFLLENBQUNNLElBQU4sQ0FBV3RDLE1BQVg7QUFFQSxRQUFNaUIsaUJBQWlCLEdBQUdqQixNQUFNLENBQUN1QyxvQkFBUCxFQUExQjtBQUVBdEIsSUFBQUEsaUJBQWlCLENBQUN1QixPQUFsQixDQUEwQixVQUFDcEIsZUFBRCxFQUFxQjtBQUM3QyxVQUFNcUIsd0JBQXdCLEdBQUdyQixlQUFlLENBQUNzQixXQUFoQixFQUFqQztBQUFBLFVBQ01DLG1DQUFtQyxHQUFHRix3QkFENUMsQ0FENkMsQ0FFMEI7O0FBRXZFLFVBQUlFLG1DQUFKLEVBQXlDO0FBQ3ZDVCxRQUFBQSxxQkFBcUIsQ0FBQ2QsZUFBRCxDQUFyQjtBQUVBLFlBQU13QiwwQkFBMEIsR0FBR3hCLGVBQWUsQ0FBQ3lCLGNBQWhCLEVBQW5DO0FBRUE3QyxRQUFBQSxNQUFNLENBQUM4QyxpQkFBUCxDQUF5QkYsMEJBQXpCO0FBQ0QsT0FORCxNQU1PO0FBQ0wsWUFBTUcsc0JBQXNCLEdBQUczQixlQUFlLENBQUM0QixTQUFoQixFQUEvQjs7QUFFQSxZQUFJRCxzQkFBSixFQUE0QjtBQUMxQixjQUFNRSxvQkFBb0IsR0FBRzdCLGVBQWUsQ0FBQzhCLFFBQWhCLEVBQTdCO0FBRUFsRCxVQUFBQSxNQUFNLENBQUM4QyxpQkFBUCxDQUF5Qkcsb0JBQXpCO0FBQ0Q7QUFDRjtBQUNGLEtBbkJEO0FBcUJBLFFBQU1FLFlBQVksR0FBR25ELE1BQU0sQ0FBQ29ELFFBQVAsRUFBckI7O0FBRUEsUUFBSUQsWUFBSixFQUFrQjtBQUNoQixVQUFNRSwwQkFBMEIsR0FBR2hFLDBCQUEwQixDQUFDaUUsa0JBQTNCLENBQThDdEIsS0FBOUMsRUFBcURoQyxNQUFyRCxDQUFuQztBQUVBTixNQUFBQSwyQkFBMkIsQ0FBQzRDLElBQTVCLENBQWlDZSwwQkFBakM7QUFDRDtBQUNGOztBQUVEMUQsRUFBQUEsUUFBUSxDQUFDNkMsT0FBVCxDQUFpQixVQUFDeEMsTUFBRCxFQUFZO0FBQzNCLFFBQU11RCxlQUFlLEdBQUd2RCxNQUFNLENBQUMwQyxXQUFQLEVBQXhCOztBQUVBLFFBQUlhLGVBQUosRUFBcUI7QUFDbkJyQixNQUFBQSxxQkFBcUIsQ0FBQ2xDLE1BQUQsQ0FBckI7QUFDRDtBQUNGLEdBTkQ7QUFRQSxTQUFPTiwyQkFBUDtBQUNEOztBQUVELFNBQVNnQixxQ0FBVCxDQUErQ2hCLDJCQUEvQyxFQUE0RTtBQUMxRSxNQUFNRSxNQUFNLEdBQUdGLDJCQUEyQixDQUFDVyxNQUE1QixDQUFtQyxVQUFDVCxNQUFELEVBQVN5RCwwQkFBVCxFQUF3QztBQUN4RixRQUFNRyxnQ0FBZ0MsR0FBR0gsMEJBQTBCLENBQUNJLFFBQTNCLEVBQXpDOztBQUVBLFFBQUlELGdDQUFKLEVBQXNDO0FBQ3BDLFVBQU1FLEtBQUssR0FBR3pFLEtBQUssQ0FBQzBFLDhCQUFOLENBQXFDTiwwQkFBckMsQ0FBZDtBQUVBekQsTUFBQUEsTUFBTSxDQUFDMEMsSUFBUCxDQUFZb0IsS0FBWjtBQUNEOztBQUVELFdBQU85RCxNQUFQO0FBQ0QsR0FWYyxFQVVaLEVBVlksQ0FBZjtBQVlBLFNBQU9BLE1BQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyBhcnJheVV0aWxpdGllcyB9IGZyb20gXCJuZWNlc3NhcnlcIjtcblxuY29uc3QgQ3ljbGUgPSByZXF1aXJlKFwiLi9ncmFwaC9jeWNsZVwiKSxcbiAgICAgIFN0YWNrID0gcmVxdWlyZShcIi4vZ3JhcGgvc3RhY2tcIiksXG4gICAgICBWZXJ0ZXggPSByZXF1aXJlKFwiLi9ncmFwaC92ZXJ0ZXhcIiksXG4gICAgICBTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCA9IHJlcXVpcmUoXCIuL2dyYXBoL3N0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50XCIpO1xuXG5jb25zdCB7IGZpcnN0LCBzZWNvbmQgfSA9IGFycmF5VXRpbGl0aWVzO1xuXG5jbGFzcyBHcmFwaCB7XG4gIGNvbnN0cnVjdG9yIChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMsIHZlcnRpY2VzLCBjeWNsZXMpIHtcbiAgICB0aGlzLnN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cztcbiAgICB0aGlzLnZlcnRpY2VzID0gdmVydGljZXM7XG4gICAgdGhpcy5jeWNsZXMgPSBjeWNsZXM7XG4gIH1cblxuICBnZXRTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzO1xuICB9XG5cbiAgZ2V0VmVydGljZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMudmVydGljZXM7XG4gIH1cblxuICBnZXRDeWNsZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3ljbGVzO1xuICB9XG4gIFxuICBpc1ZlcnRleFByZXNlbnQobmFtZSkge1xuICAgIGNvbnN0IHZlcnRleFByZXNlbnQgPSB0aGlzLnZlcnRpY2VzLnNvbWUoKHZlcnRleCkgPT4ge1xuICAgICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCk7XG4gICAgICBcbiAgICAgIGlmICh2ZXJ0ZXhOYW1lID09PSBuYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHZlcnRleFByZXNlbnQ7XG4gIH1cblxuICBzdGF0aWMgZnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSB7XG4gICAgY29uc3QgdmVydGV4TWFwID0gdmVydGV4TGl0ZXJhbHMucmVkdWNlKCh2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpID0+IHtcbiAgICAgICAgICAgIGFkZFZlcnRleExpdGVyYWwodmVydGV4TWFwLCB2ZXJ0ZXhMaXRlcmFsKTsgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHZlcnRleE1hcDtcbiAgICAgICAgICB9LCB7fSksXG4gICAgICAgICAgdmVydGljZXMgPSB2ZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSxcbiAgICAgICAgICBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHNGcm9tVmVydGljZXModmVydGljZXMpLFxuICAgICAgICAgIGN5Y2xlcyA9IGN5Y2xlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKSxcbiAgICAgICAgICBncmFwaCA9IG5ldyBHcmFwaChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMsIHZlcnRpY2VzLCBjeWNsZXMpO1xuICAgIFxuICAgIHJldHVybiBncmFwaDtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEdyYXBoO1xuXG5mdW5jdGlvbiBhZGRWZXJ0ZXhMaXRlcmFsKHZlcnRleE1hcCwgdmVydGV4TGl0ZXJhbCkge1xuICBjb25zdCBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50ID0gZmlyc3QodmVydGV4TGl0ZXJhbCksXG4gICAgICAgIHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50ID0gc2Vjb25kKHZlcnRleExpdGVyYWwpLFxuICAgICAgICB2ZXJ0ZXhOYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICBsZXQgc3VjY2Vzc29yVmVydGljZXMgPSBkZXNjZW5kYW50VmVydGV4TmFtZXMubWFwKChkZXNjZW5kYW50VmVydGV4TmFtZSkgPT4ge1xuICAgIGxldCBzdWNjZXNzb3JWZXJ0ZXg7XG5cbiAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhOYW1lID0gZGVzY2VuZGFudFZlcnRleE5hbWUsICAvLy9cbiAgICAgICAgICBzdWNjZXNzb3JWZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkoc3VjY2Vzc29yVmVydGV4TmFtZSk7XG5cbiAgICBpZiAoc3VjY2Vzc29yVmVydGV4RXhpc3RzKSB7XG4gICAgICBzdWNjZXNzb3JWZXJ0ZXggPSB2ZXJ0ZXhNYXBbc3VjY2Vzc29yVmVydGV4TmFtZV07XG4gICAgfSBlbHNlIHtcbiAgICAgIHN1Y2Nlc3NvclZlcnRleCA9IFZlcnRleC5mcm9tVmVydGV4TmFtZShzdWNjZXNzb3JWZXJ0ZXhOYW1lKTtcblxuICAgICAgdmVydGV4TWFwW3N1Y2Nlc3NvclZlcnRleE5hbWVdID0gc3VjY2Vzc29yVmVydGV4O1xuICAgIH1cblxuICAgIHJldHVybiBzdWNjZXNzb3JWZXJ0ZXg7XG4gIH0pO1xuXG4gIGxldCB2ZXJ0ZXg7XG5cbiAgY29uc3QgdmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KHZlcnRleE5hbWUpO1xuXG4gIGlmICh2ZXJ0ZXhFeGlzdHMpIHtcbiAgICB2ZXJ0ZXggPSB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV07XG4gIH0gZWxzZSB7XG4gICAgdmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHZlcnRleE5hbWUpO1xuXG4gICAgdmVydGV4TWFwW3ZlcnRleE5hbWVdID0gdmVydGV4O1xuICB9XG5cbiAgc3VjY2Vzc29yVmVydGljZXMgPSBzdWNjZXNzb3JWZXJ0aWNlcy5jb25jYXQoW10pLnJldmVyc2UoKTsgLy8vXG5cbiAgdmVydGV4LnNldFN1Y2Nlc3NvclZlcnRpY2VzKHN1Y2Nlc3NvclZlcnRpY2VzKTtcbn1cblxuZnVuY3Rpb24gdmVydGljZXNGcm9tVmVydGV4TWFwKHZlcnRleE1hcCkge1xuICBjb25zdCB2ZXJ0ZXhOYW1lcyA9IE9iamVjdC5rZXlzKHZlcnRleE1hcCksXG4gICAgICAgIHZlcnRpY2VzID0gdmVydGV4TmFtZXMubWFwKCh2ZXJ0ZXhOYW1lKSA9PiB7XG4gICAgICAgICAgY29uc3QgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdO1xuICBcbiAgICAgICAgICByZXR1cm4gdmVydGV4O1xuICAgICAgICB9KTtcblxuICByZXR1cm4gdmVydGljZXM7XG59XG5cbmZ1bmN0aW9uIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50c0Zyb21WZXJ0aWNlcyh2ZXJ0aWNlcykge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpLFxuICAgICAgICBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMgPSBbXTtcblxuICBsZXQgaW5kZXggPSAwO1xuXG4gIGZ1bmN0aW9uIHN0cm9uZ2x5Q29ubmVjdFZlcnRleCh2ZXJ0ZXgpIHtcbiAgICBjb25zdCBsb3dlc3RJbmRleCA9IGluZGV4OyAgLy8vXG5cbiAgICB2ZXJ0ZXguc2V0SW5kZXgoaW5kZXgpO1xuXG4gICAgdmVydGV4LnNldExvd2VzdEluZGV4KGxvd2VzdEluZGV4KTtcblxuICAgIGluZGV4Kys7XG5cbiAgICBzdGFjay5wdXNoKHZlcnRleCk7XG5cbiAgICBjb25zdCBzdWNjZXNzb3JWZXJ0aWNlcyA9IHZlcnRleC5nZXRTdWNjZXNzb3JWZXJ0aWNlcygpO1xuXG4gICAgc3VjY2Vzc29yVmVydGljZXMuZm9yRWFjaCgoc3VjY2Vzc29yVmVydGV4KSA9PiB7XG4gICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQgPSBzdWNjZXNzb3JWZXJ0ZXguaXNVbmluZGV4ZWQoKSxcbiAgICAgICAgICAgIHN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkID0gc3VjY2Vzc29yVmVydGV4VW5pbmRleGVkOyAgLy8vXG5cbiAgICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhOb3RTdHJvbmdseUNvbm5lY3RlZCkge1xuICAgICAgICBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgoc3VjY2Vzc29yVmVydGV4KTtcblxuICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCA9IHN1Y2Nlc3NvclZlcnRleC5nZXRMb3dlc3RJbmRleCgpO1xuXG4gICAgICAgIHZlcnRleC51cGRhdGVMb3dlc3RJbmRleChzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkID0gc3VjY2Vzc29yVmVydGV4LmlzU3RhY2tlZCgpO1xuXG4gICAgICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkKSB7XG4gICAgICAgICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4SW5kZXggPSBzdWNjZXNzb3JWZXJ0ZXguZ2V0SW5kZXgoKTtcblxuICAgICAgICAgIHZlcnRleC51cGRhdGVMb3dlc3RJbmRleChzdWNjZXNzb3JWZXJ0ZXhJbmRleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHZlcnRleExvd2VzdCA9IHZlcnRleC5pc0xvd2VzdCgpO1xuXG4gICAgaWYgKHZlcnRleExvd2VzdCkge1xuICAgICAgY29uc3Qgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQgPSBTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5mcm9tU3RhY2tBbmRWZXJ0ZXgoc3RhY2ssIHZlcnRleCk7XG5cbiAgICAgIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cy5wdXNoKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICB2ZXJ0aWNlcy5mb3JFYWNoKCh2ZXJ0ZXgpID0+IHtcbiAgICBjb25zdCB2ZXJ0ZXhVbmluZGV4ZWQgPSB2ZXJ0ZXguaXNVbmluZGV4ZWQoKTtcblxuICAgIGlmICh2ZXJ0ZXhVbmluZGV4ZWQpIHtcbiAgICAgIHN0cm9uZ2x5Q29ubmVjdFZlcnRleCh2ZXJ0ZXgpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cztcbn1cblxuZnVuY3Rpb24gY3ljbGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyhzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMpIHtcbiAgY29uc3QgY3ljbGVzID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLnJlZHVjZSgoY3ljbGVzLCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCkgPT4ge1xuICAgIGNvbnN0IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Q3ljbGljID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQuaXNDeWNsaWMoKTtcblxuICAgIGlmIChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYykge1xuICAgICAgY29uc3QgY3ljbGUgPSBDeWNsZS5mcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQpO1xuXG4gICAgICBjeWNsZXMucHVzaChjeWNsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGN5Y2xlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjeWNsZXM7XG59XG4iXX0=