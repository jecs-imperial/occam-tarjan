'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Cycle = require('./graph/cycle'),
    Stack = require('./graph/stack'),
    Vertex = require('./graph/vertex'),
    Component = require('./graph/component'),
    arrayUtil = require('./util/array');

var Graph = function () {
  function Graph(vertices, components, cycles) {
    _classCallCheck(this, Graph);

    this.vertices = vertices;
    this.components = components;
    this.cycles = cycles;
  }

  _createClass(Graph, [{
    key: 'getVertices',
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: 'getComponents',
    value: function getComponents() {
      return this.components;
    }
  }, {
    key: 'getCycles',
    value: function getCycles() {
      return this.cycles;
    }
  }, {
    key: 'isVertexPresent',
    value: function isVertexPresent(name) {
      var vertexPresent = this.vertices.some(function (vertex) {
        var vertexName = vertex.getName();

        if (vertexName === name) {
          return true;
        }
      });

      return vertexPresent;
    }
  }], [{
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexLiterals.reduce(function (vertexMap, vertexLiteral) {
        addVertexLiteral(vertexMap, vertexLiteral);

        return vertexMap;
      }, {}),
          vertices = verticesFromVertexMap(vertexMap),
          components = componentsFromVertices(vertices),
          cycles = cyclesFromComponents(components),
          graph = new Graph(vertices, components, cycles);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function addVertexLiteral(vertexMap, vertexLiteral) {
  var firstVertexLiteralElement = arrayUtil.first(vertexLiteral),
      secondVertexLiteralElement = arrayUtil.second(vertexLiteral),
      name = firstVertexLiteralElement,
      ///
  descendantVertexNames = secondVertexLiteralElement; ///

  var successorVertices = descendantVertexNames.map(function (descendantVertexName) {
    var successorVertex = void 0;

    var successorVertexName = descendantVertexName,
        ///
    successorVertexExists = vertexMap.hasOwnProperty(successorVertexName);

    if (successorVertexExists) {
      successorVertex = vertexMap[successorVertexName];
    } else {
      successorVertex = Vertex.fromName(successorVertexName);

      vertexMap[successorVertexName] = successorVertex;
    }

    return successorVertex;
  });

  var vertex = void 0;

  var vertexExists = vertexMap.hasOwnProperty(name);

  if (vertexExists) {
    vertex = vertexMap[name];
  } else {
    vertex = Vertex.fromName(name);

    vertexMap[name] = vertex;
  }

  successorVertices = successorVertices.concat([]).reverse(); ///

  vertex.setSuccessorVertices(successorVertices);
}

function verticesFromVertexMap(vertexMap) {
  var names = Object.keys(vertexMap),
      vertices = names.map(function (name) {
    var vertex = vertexMap[name];

    return vertex;
  });

  return vertices;
}

function componentsFromVertices(vertices) {
  var stack = new Stack(),
      components = [];

  var index = 0;

  function stronglyConnectVertex(vertex) {
    var lowestIndex = index; ///

    vertex.setIndex(index);

    vertex.setLowestIndex(lowestIndex);

    index++;

    stack.push(vertex);

    var successorVertices = vertex.getSuccessorVertices();

    successorVertices.forEach(function (successorVertex) {
      var successorVertexUnindexed = successorVertex.isUnindexed(),
          successorVertexNotStronglyConnected = successorVertexUnindexed; ///

      if (successorVertexNotStronglyConnected) {
        stronglyConnectVertex(successorVertex);

        var successorVertexLowestIndex = successorVertex.getLowestIndex();

        vertex.updateLowestIndex(successorVertexLowestIndex);
      } else {
        var successorVertexStacked = successorVertex.isStacked();

        if (successorVertexStacked) {
          var successorVertexIndex = successorVertex.getIndex();

          vertex.updateLowestIndex(successorVertexIndex);
        }
      }
    });

    var vertexLowest = vertex.isLowest();

    if (vertexLowest) {
      var component = Component.fromStackAndVertex(stack, vertex);

      components.push(component);
    }
  }

  vertices.forEach(function (vertex) {
    var vertexUnindexed = vertex.isUnindexed();

    if (vertexUnindexed) {
      stronglyConnectVertex(vertex);
    }
  });

  return components;
}

function cyclesFromComponents(components) {
  var cycles = components.reduce(function (cycles, component) {
    var componentCyclic = component.isCyclic();

    if (componentCyclic) {
      var cycle = Cycle.fromComponent(component);

      cycles.push(cycle);
    }

    return cycles;
  }, []);

  return cycles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJDeWNsZSIsInJlcXVpcmUiLCJTdGFjayIsIlZlcnRleCIsIkNvbXBvbmVudCIsImFycmF5VXRpbCIsIkdyYXBoIiwidmVydGljZXMiLCJjb21wb25lbnRzIiwiY3ljbGVzIiwibmFtZSIsInZlcnRleFByZXNlbnQiLCJzb21lIiwidmVydGV4IiwidmVydGV4TmFtZSIsImdldE5hbWUiLCJ2ZXJ0ZXhMaXRlcmFscyIsInZlcnRleE1hcCIsInJlZHVjZSIsInZlcnRleExpdGVyYWwiLCJhZGRWZXJ0ZXhMaXRlcmFsIiwidmVydGljZXNGcm9tVmVydGV4TWFwIiwiY29tcG9uZW50c0Zyb21WZXJ0aWNlcyIsImN5Y2xlc0Zyb21Db21wb25lbnRzIiwiZ3JhcGgiLCJtb2R1bGUiLCJleHBvcnRzIiwiZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCIsImZpcnN0Iiwic2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQiLCJzZWNvbmQiLCJkZXNjZW5kYW50VmVydGV4TmFtZXMiLCJzdWNjZXNzb3JWZXJ0aWNlcyIsIm1hcCIsImRlc2NlbmRhbnRWZXJ0ZXhOYW1lIiwic3VjY2Vzc29yVmVydGV4Iiwic3VjY2Vzc29yVmVydGV4TmFtZSIsInN1Y2Nlc3NvclZlcnRleEV4aXN0cyIsImhhc093blByb3BlcnR5IiwiZnJvbU5hbWUiLCJ2ZXJ0ZXhFeGlzdHMiLCJjb25jYXQiLCJyZXZlcnNlIiwic2V0U3VjY2Vzc29yVmVydGljZXMiLCJuYW1lcyIsIk9iamVjdCIsImtleXMiLCJzdGFjayIsImluZGV4Iiwic3Ryb25nbHlDb25uZWN0VmVydGV4IiwibG93ZXN0SW5kZXgiLCJzZXRJbmRleCIsInNldExvd2VzdEluZGV4IiwicHVzaCIsImdldFN1Y2Nlc3NvclZlcnRpY2VzIiwiZm9yRWFjaCIsInN1Y2Nlc3NvclZlcnRleFVuaW5kZXhlZCIsImlzVW5pbmRleGVkIiwic3VjY2Vzc29yVmVydGV4Tm90U3Ryb25nbHlDb25uZWN0ZWQiLCJzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCIsImdldExvd2VzdEluZGV4IiwidXBkYXRlTG93ZXN0SW5kZXgiLCJzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkIiwiaXNTdGFja2VkIiwic3VjY2Vzc29yVmVydGV4SW5kZXgiLCJnZXRJbmRleCIsInZlcnRleExvd2VzdCIsImlzTG93ZXN0IiwiY29tcG9uZW50IiwiZnJvbVN0YWNrQW5kVmVydGV4IiwidmVydGV4VW5pbmRleGVkIiwiY29tcG9uZW50Q3ljbGljIiwiaXNDeWNsaWMiLCJjeWNsZSIsImZyb21Db21wb25lbnQiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxRQUFRQyxRQUFRLGVBQVIsQ0FBZDtBQUFBLElBQ01DLFFBQVFELFFBQVEsZUFBUixDQURkO0FBQUEsSUFFTUUsU0FBU0YsUUFBUSxnQkFBUixDQUZmO0FBQUEsSUFHTUcsWUFBWUgsUUFBUSxtQkFBUixDQUhsQjtBQUFBLElBSU1JLFlBQVlKLFFBQVEsY0FBUixDQUpsQjs7SUFNTUssSztBQUNKLGlCQUFhQyxRQUFiLEVBQXVCQyxVQUF2QixFQUFtQ0MsTUFBbkMsRUFBMkM7QUFBQTs7QUFDekMsU0FBS0YsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxVQUFMLEdBQWtCQSxVQUFsQjtBQUNBLFNBQUtDLE1BQUwsR0FBY0EsTUFBZDtBQUNEOzs7O2tDQUVhO0FBQ1osYUFBTyxLQUFLRixRQUFaO0FBQ0Q7OztvQ0FFZTtBQUNkLGFBQU8sS0FBS0MsVUFBWjtBQUNEOzs7Z0NBRVc7QUFDVixhQUFPLEtBQUtDLE1BQVo7QUFDRDs7O29DQUVlQyxJLEVBQU07QUFDcEIsVUFBTUMsZ0JBQWdCLEtBQUtKLFFBQUwsQ0FBY0ssSUFBZCxDQUFtQixVQUFTQyxNQUFULEVBQWlCO0FBQ3hELFlBQU1DLGFBQWFELE9BQU9FLE9BQVAsRUFBbkI7O0FBRUEsWUFBSUQsZUFBZUosSUFBbkIsRUFBeUI7QUFDdkIsaUJBQU8sSUFBUDtBQUNEO0FBQ0YsT0FOcUIsQ0FB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QztBQUN4QyxNQUFNQyxTQUFTRCxXQUFXVSxNQUFYLENBQWtCLFVBQVNULE1BQVQsRUFBaUIyRCxTQUFqQixFQUE0QjtBQUMzRCxRQUFNRyxrQkFBa0JILFVBQVVJLFFBQVYsRUFBeEI7O0FBRUEsUUFBSUQsZUFBSixFQUFxQjtBQUNuQixVQUFNRSxRQUFRekUsTUFBTTBFLGFBQU4sQ0FBb0JOLFNBQXBCLENBQWQ7O0FBRUEzRCxhQUFPNEMsSUFBUCxDQUFZb0IsS0FBWjtBQUNEOztBQUVELFdBQU9oRSxNQUFQO0FBQ0QsR0FWYyxFQVVaLEVBVlksQ0FBZjs7QUFZQSxTQUFPQSxNQUFQO0FBQ0QiLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IEN5Y2xlID0gcmVxdWlyZSgnLi9ncmFwaC9jeWNsZScpLFxuICAgICAgU3RhY2sgPSByZXF1aXJlKCcuL2dyYXBoL3N0YWNrJyksXG4gICAgICBWZXJ0ZXggPSByZXF1aXJlKCcuL2dyYXBoL3ZlcnRleCcpLFxuICAgICAgQ29tcG9uZW50ID0gcmVxdWlyZSgnLi9ncmFwaC9jb21wb25lbnQnKSxcbiAgICAgIGFycmF5VXRpbCA9IHJlcXVpcmUoJy4vdXRpbC9hcnJheScpO1xuXG5jbGFzcyBHcmFwaCB7XG4gIGNvbnN0cnVjdG9yICh2ZXJ0aWNlcywgY29tcG9uZW50cywgY3ljbGVzKSB7XG4gICAgdGhpcy52ZXJ0aWNlcyA9IHZlcnRpY2VzO1xuICAgIHRoaXMuY29tcG9uZW50cyA9IGNvbXBvbmVudHM7XG4gICAgdGhpcy5jeWNsZXMgPSBjeWNsZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNlcygpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJ0aWNlcztcbiAgfVxuXG4gIGdldENvbXBvbmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcG9uZW50cztcbiAgfVxuICBcbiAgZ2V0Q3ljbGVzKCkge1xuICAgIHJldHVybiB0aGlzLmN5Y2xlcztcbiAgfVxuICBcbiAgaXNWZXJ0ZXhQcmVzZW50KG5hbWUpIHtcbiAgICBjb25zdCB2ZXJ0ZXhQcmVzZW50ID0gdGhpcy52ZXJ0aWNlcy5zb21lKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCk7XG4gICAgICBcbiAgICAgIGlmICh2ZXJ0ZXhOYW1lID09PSBuYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHZlcnRleFByZXNlbnQ7XG4gIH1cblxuICBzdGF0aWMgZnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSB7XG4gICAgY29uc3QgdmVydGV4TWFwID0gdmVydGV4TGl0ZXJhbHMucmVkdWNlKGZ1bmN0aW9uKHZlcnRleE1hcCwgdmVydGV4TGl0ZXJhbCkge1xuICAgICAgICAgICAgYWRkVmVydGV4TGl0ZXJhbCh2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpOyAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdmVydGV4TWFwO1xuICAgICAgICAgIH0sIHt9KSxcbiAgICAgICAgICB2ZXJ0aWNlcyA9IHZlcnRpY2VzRnJvbVZlcnRleE1hcCh2ZXJ0ZXhNYXApLFxuICAgICAgICAgIGNvbXBvbmVudHMgPSBjb21wb25lbnRzRnJvbVZlcnRpY2VzKHZlcnRpY2VzKSxcbiAgICAgICAgICBjeWNsZXMgPSBjeWNsZXNGcm9tQ29tcG9uZW50cyhjb21wb25lbnRzKSxcbiAgICAgICAgICBncmFwaCA9IG5ldyBHcmFwaCh2ZXJ0aWNlcywgY29tcG9uZW50cywgY3ljbGVzKTtcbiAgICBcbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBHcmFwaDtcblxuZnVuY3Rpb24gYWRkVmVydGV4TGl0ZXJhbCh2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5VXRpbC5maXJzdCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBhcnJheVV0aWwuc2Vjb25kKHZlcnRleExpdGVyYWwpLFxuICAgICAgICBuYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICBsZXQgc3VjY2Vzc29yVmVydGljZXMgPSBkZXNjZW5kYW50VmVydGV4TmFtZXMubWFwKGZ1bmN0aW9uKGRlc2NlbmRhbnRWZXJ0ZXhOYW1lKSB7XG4gICAgbGV0IHN1Y2Nlc3NvclZlcnRleDtcblxuICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleE5hbWUgPSBkZXNjZW5kYW50VmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHN1Y2Nlc3NvclZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eShzdWNjZXNzb3JWZXJ0ZXhOYW1lKTtcblxuICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhFeGlzdHMpIHtcbiAgICAgIHN1Y2Nlc3NvclZlcnRleCA9IHZlcnRleE1hcFtzdWNjZXNzb3JWZXJ0ZXhOYW1lXTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3VjY2Vzc29yVmVydGV4ID0gVmVydGV4LmZyb21OYW1lKHN1Y2Nlc3NvclZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbc3VjY2Vzc29yVmVydGV4TmFtZV0gPSBzdWNjZXNzb3JWZXJ0ZXg7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1Y2Nlc3NvclZlcnRleDtcbiAgfSk7XG5cbiAgbGV0IHZlcnRleDtcblxuICBjb25zdCB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkobmFtZSk7XG5cbiAgaWYgKHZlcnRleEV4aXN0cykge1xuICAgIHZlcnRleCA9IHZlcnRleE1hcFtuYW1lXTtcbiAgfSBlbHNlIHtcbiAgICB2ZXJ0ZXggPSBWZXJ0ZXguZnJvbU5hbWUobmFtZSk7XG5cbiAgICB2ZXJ0ZXhNYXBbbmFtZV0gPSB2ZXJ0ZXg7XG4gIH1cblxuICBzdWNjZXNzb3JWZXJ0aWNlcyA9IHN1Y2Nlc3NvclZlcnRpY2VzLmNvbmNhdChbXSkucmV2ZXJzZSgpOyAvLy9cblxuICB2ZXJ0ZXguc2V0U3VjY2Vzc29yVmVydGljZXMoc3VjY2Vzc29yVmVydGljZXMpO1xufVxuXG5mdW5jdGlvbiB2ZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSB7XG4gIGNvbnN0IG5hbWVzID0gT2JqZWN0LmtleXModmVydGV4TWFwKSxcbiAgICAgICAgdmVydGljZXMgPSBuYW1lcy5tYXAoZnVuY3Rpb24obmFtZSkge1xuICAgICAgICAgIGNvbnN0IHZlcnRleCA9IHZlcnRleE1hcFtuYW1lXTtcbiAgXG4gICAgICAgICAgcmV0dXJuIHZlcnRleDtcbiAgICAgICAgfSk7XG5cbiAgcmV0dXJuIHZlcnRpY2VzO1xufVxuXG5mdW5jdGlvbiBjb21wb25lbnRzRnJvbVZlcnRpY2VzKHZlcnRpY2VzKSB7XG4gIGNvbnN0IHN0YWNrID0gbmV3IFN0YWNrKCksXG4gICAgICAgIGNvbXBvbmVudHMgPSBbXTtcblxuICBsZXQgaW5kZXggPSAwO1xuXG4gIGZ1bmN0aW9uIHN0cm9uZ2x5Q29ubmVjdFZlcnRleCh2ZXJ0ZXgpIHtcbiAgICBjb25zdCBsb3dlc3RJbmRleCA9IGluZGV4OyAgLy8vXG5cbiAgICB2ZXJ0ZXguc2V0SW5kZXgoaW5kZXgpO1xuXG4gICAgdmVydGV4LnNldExvd2VzdEluZGV4KGxvd2VzdEluZGV4KTtcblxuICAgIGluZGV4Kys7XG5cbiAgICBzdGFjay5wdXNoKHZlcnRleCk7XG5cbiAgICBjb25zdCBzdWNjZXNzb3JWZXJ0aWNlcyA9IHZlcnRleC5nZXRTdWNjZXNzb3JWZXJ0aWNlcygpO1xuXG4gICAgc3VjY2Vzc29yVmVydGljZXMuZm9yRWFjaChmdW5jdGlvbihzdWNjZXNzb3JWZXJ0ZXgpIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleFVuaW5kZXhlZCA9IHN1Y2Nlc3NvclZlcnRleC5pc1VuaW5kZXhlZCgpLFxuICAgICAgICAgICAgc3VjY2Vzc29yVmVydGV4Tm90U3Ryb25nbHlDb25uZWN0ZWQgPSBzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQ7ICAvLy9cblxuICAgICAgaWYgKHN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkKSB7XG4gICAgICAgIHN0cm9uZ2x5Q29ubmVjdFZlcnRleChzdWNjZXNzb3JWZXJ0ZXgpO1xuXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleExvd2VzdEluZGV4ID0gc3VjY2Vzc29yVmVydGV4LmdldExvd2VzdEluZGV4KCk7XG5cbiAgICAgICAgdmVydGV4LnVwZGF0ZUxvd2VzdEluZGV4KHN1Y2Nlc3NvclZlcnRleExvd2VzdEluZGV4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleFN0YWNrZWQgPSBzdWNjZXNzb3JWZXJ0ZXguaXNTdGFja2VkKCk7XG5cbiAgICAgICAgaWYgKHN1Y2Nlc3NvclZlcnRleFN0YWNrZWQpIHtcbiAgICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhJbmRleCA9IHN1Y2Nlc3NvclZlcnRleC5nZXRJbmRleCgpO1xuXG4gICAgICAgICAgdmVydGV4LnVwZGF0ZUxvd2VzdEluZGV4KHN1Y2Nlc3NvclZlcnRleEluZGV4KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgdmVydGV4TG93ZXN0ID0gdmVydGV4LmlzTG93ZXN0KCk7XG5cbiAgICBpZiAodmVydGV4TG93ZXN0KSB7XG4gICAgICBjb25zdCBjb21wb25lbnQgPSBDb21wb25lbnQuZnJvbVN0YWNrQW5kVmVydGV4KHN0YWNrLCB2ZXJ0ZXgpO1xuXG4gICAgICBjb21wb25lbnRzLnB1c2goY29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICB2ZXJ0aWNlcy5mb3JFYWNoKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgIGNvbnN0IHZlcnRleFVuaW5kZXhlZCA9IHZlcnRleC5pc1VuaW5kZXhlZCgpO1xuXG4gICAgaWYgKHZlcnRleFVuaW5kZXhlZCkge1xuICAgICAgc3Ryb25nbHlDb25uZWN0VmVydGV4KHZlcnRleCk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gY29tcG9uZW50cztcbn1cblxuZnVuY3Rpb24gY3ljbGVzRnJvbUNvbXBvbmVudHMoY29tcG9uZW50cykge1xuICBjb25zdCBjeWNsZXMgPSBjb21wb25lbnRzLnJlZHVjZShmdW5jdGlvbihjeWNsZXMsIGNvbXBvbmVudCkge1xuICAgIGNvbnN0IGNvbXBvbmVudEN5Y2xpYyA9IGNvbXBvbmVudC5pc0N5Y2xpYygpO1xuXG4gICAgaWYgKGNvbXBvbmVudEN5Y2xpYykge1xuICAgICAgY29uc3QgY3ljbGUgPSBDeWNsZS5mcm9tQ29tcG9uZW50KGNvbXBvbmVudCk7XG5cbiAgICAgIGN5Y2xlcy5wdXNoKGN5Y2xlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY3ljbGVzO1xuICB9LCBbXSk7XG5cbiAgcmV0dXJuIGN5Y2xlcztcbn1cbiJdfQ==