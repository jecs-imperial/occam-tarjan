"use strict";

var _necessary = require("necessary");

var _cycle = _interopRequireDefault(require("./graph/cycle"));

var _stack = _interopRequireDefault(require("./graph/stack"));

var _vertex = _interopRequireDefault(require("./graph/vertex"));

var _stronglyConnectedComponent = _interopRequireDefault(require("./graph/stronglyConnectedComponent"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var first = _necessary.arrayUtilities.first,
    second = _necessary.arrayUtilities.second;

var Graph = /*#__PURE__*/function () {
  function Graph(stronglyConnectedComponents, vertices, cycles) {
    _classCallCheck(this, Graph);

    this.stronglyConnectedComponents = stronglyConnectedComponents;
    this.vertices = vertices;
    this.cycles = cycles;
  }

  _createClass(Graph, [{
    key: "getStronglyConnectedComponents",
    value: function getStronglyConnectedComponents() {
      return this.stronglyConnectedComponents;
    }
  }, {
    key: "getVertices",
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: "getCycles",
    value: function getCycles() {
      return this.cycles;
    }
  }, {
    key: "isVertexPresent",
    value: function isVertexPresent(name) {
      var vertexPresent = this.vertices.some(function (vertex) {
        var vertexName = vertex.getName();

        if (vertexName === name) {
          return true;
        }
      });
      return vertexPresent;
    }
  }], [{
    key: "fromVertexLiterals",
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexLiterals.reduce(function (vertexMap, vertexLiteral) {
        addVertexLiteral(vertexMap, vertexLiteral);
        return vertexMap;
      }, {}),
          vertices = verticesFromVertexMap(vertexMap),
          stronglyConnectedComponents = stronglyConnectedComponentsFromVertices(vertices),
          cycles = cyclesFromStronglyConnectedComponents(stronglyConnectedComponents),
          graph = new Graph(stronglyConnectedComponents, vertices, cycles);
      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function addVertexLiteral(vertexMap, vertexLiteral) {
  var firstVertexLiteralElement = first(vertexLiteral),
      secondVertexLiteralElement = second(vertexLiteral),
      vertexName = firstVertexLiteralElement,
      ///
  descendantVertexNames = secondVertexLiteralElement; ///

  var successorVertices = descendantVertexNames.map(function (descendantVertexName) {
    var successorVertex;
    var successorVertexName = descendantVertexName,
        ///
    successorVertexExists = vertexMap.hasOwnProperty(successorVertexName);

    if (successorVertexExists) {
      successorVertex = vertexMap[successorVertexName];
    } else {
      successorVertex = _vertex["default"].fromVertexName(successorVertexName);
      vertexMap[successorVertexName] = successorVertex;
    }

    return successorVertex;
  });
  var vertex;
  var vertexExists = vertexMap.hasOwnProperty(vertexName);

  if (vertexExists) {
    vertex = vertexMap[vertexName];
  } else {
    vertex = _vertex["default"].fromVertexName(vertexName);
    vertexMap[vertexName] = vertex;
  }

  successorVertices = successorVertices.concat([]).reverse(); ///

  vertex.setSuccessorVertices(successorVertices);
}

function verticesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      vertices = vertexNames.map(function (vertexName) {
    var vertex = vertexMap[vertexName];
    return vertex;
  });
  return vertices;
}

function stronglyConnectedComponentsFromVertices(vertices) {
  var stack = new _stack["default"](),
      stronglyConnectedComponents = [];
  var index = 0;

  function stronglyConnectVertex(vertex) {
    var lowestIndex = index; ///

    vertex.setIndex(index);
    vertex.setLowestIndex(lowestIndex);
    index++;
    stack.push(vertex);
    var successorVertices = vertex.getSuccessorVertices();
    successorVertices.forEach(function (successorVertex) {
      var successorVertexUnindexed = successorVertex.isUnindexed(),
          successorVertexNotStronglyConnected = successorVertexUnindexed; ///

      if (successorVertexNotStronglyConnected) {
        stronglyConnectVertex(successorVertex);
        var successorVertexLowestIndex = successorVertex.getLowestIndex();
        vertex.updateLowestIndex(successorVertexLowestIndex);
      } else {
        var successorVertexStacked = successorVertex.isStacked();

        if (successorVertexStacked) {
          var successorVertexIndex = successorVertex.getIndex();
          vertex.updateLowestIndex(successorVertexIndex);
        }
      }
    });
    var vertexLowest = vertex.isLowest();

    if (vertexLowest) {
      var stronglyConnectedComponent = _stronglyConnectedComponent["default"].fromStackAndVertex(stack, vertex);

      stronglyConnectedComponents.push(stronglyConnectedComponent);
    }
  }

  vertices.forEach(function (vertex) {
    var vertexUnindexed = vertex.isUnindexed();

    if (vertexUnindexed) {
      stronglyConnectVertex(vertex);
    }
  });
  return stronglyConnectedComponents;
}

function cyclesFromStronglyConnectedComponents(stronglyConnectedComponents) {
  var cycles = stronglyConnectedComponents.reduce(function (cycles, stronglyConnectedComponent) {
    var stronglyConnectedComponentCyclic = stronglyConnectedComponent.isCyclic();

    if (stronglyConnectedComponentCyclic) {
      var cycle = _cycle["default"].fromStronglyConnectedComponent(stronglyConnectedComponent);

      cycles.push(cycle);
    }

    return cycles;
  }, []);
  return cycles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdyYXBoLmpzIl0sIm5hbWVzIjpbImZpcnN0IiwiYXJyYXlVdGlsaXRpZXMiLCJzZWNvbmQiLCJHcmFwaCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsInZlcnRpY2VzIiwiY3ljbGVzIiwibmFtZSIsInZlcnRleFByZXNlbnQiLCJzb21lIiwidmVydGV4IiwidmVydGV4TmFtZSIsImdldE5hbWUiLCJ2ZXJ0ZXhMaXRlcmFscyIsInZlcnRleE1hcCIsInJlZHVjZSIsInZlcnRleExpdGVyYWwiLCJhZGRWZXJ0ZXhMaXRlcmFsIiwidmVydGljZXNGcm9tVmVydGV4TWFwIiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzRnJvbVZlcnRpY2VzIiwiY3ljbGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsImdyYXBoIiwibW9kdWxlIiwiZXhwb3J0cyIsImZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQiLCJzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudCIsImRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyIsInN1Y2Nlc3NvclZlcnRpY2VzIiwibWFwIiwiZGVzY2VuZGFudFZlcnRleE5hbWUiLCJzdWNjZXNzb3JWZXJ0ZXgiLCJzdWNjZXNzb3JWZXJ0ZXhOYW1lIiwic3VjY2Vzc29yVmVydGV4RXhpc3RzIiwiaGFzT3duUHJvcGVydHkiLCJWZXJ0ZXgiLCJmcm9tVmVydGV4TmFtZSIsInZlcnRleEV4aXN0cyIsImNvbmNhdCIsInJldmVyc2UiLCJzZXRTdWNjZXNzb3JWZXJ0aWNlcyIsInZlcnRleE5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsInN0YWNrIiwiU3RhY2siLCJpbmRleCIsInN0cm9uZ2x5Q29ubmVjdFZlcnRleCIsImxvd2VzdEluZGV4Iiwic2V0SW5kZXgiLCJzZXRMb3dlc3RJbmRleCIsInB1c2giLCJnZXRTdWNjZXNzb3JWZXJ0aWNlcyIsImZvckVhY2giLCJzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQiLCJpc1VuaW5kZXhlZCIsInN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkIiwic3VjY2Vzc29yVmVydGV4TG93ZXN0SW5kZXgiLCJnZXRMb3dlc3RJbmRleCIsInVwZGF0ZUxvd2VzdEluZGV4Iiwic3VjY2Vzc29yVmVydGV4U3RhY2tlZCIsImlzU3RhY2tlZCIsInN1Y2Nlc3NvclZlcnRleEluZGV4IiwiZ2V0SW5kZXgiLCJ2ZXJ0ZXhMb3dlc3QiLCJpc0xvd2VzdCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQiLCJmcm9tU3RhY2tBbmRWZXJ0ZXgiLCJ2ZXJ0ZXhVbmluZGV4ZWQiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYyIsImlzQ3ljbGljIiwiY3ljbGUiLCJDeWNsZSIsImZyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7SUFFUUEsSyxHQUFrQkMseUIsQ0FBbEJELEs7SUFBT0UsTSxHQUFXRCx5QixDQUFYQyxNOztJQUVUQyxLO0FBQ0osaUJBQWFDLDJCQUFiLEVBQTBDQyxRQUExQyxFQUFvREMsTUFBcEQsRUFBNEQ7QUFBQTs7QUFDMUQsU0FBS0YsMkJBQUwsR0FBbUNBLDJCQUFuQztBQUNBLFNBQUtDLFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBQ0Q7Ozs7cURBRWdDO0FBQy9CLGFBQU8sS0FBS0YsMkJBQVo7QUFDRDs7O2tDQUVhO0FBQ1osYUFBTyxLQUFLQyxRQUFaO0FBQ0Q7OztnQ0FFVztBQUNWLGFBQU8sS0FBS0MsTUFBWjtBQUNEOzs7b0NBRWVDLEksRUFBTTtBQUNwQixVQUFNQyxhQUFhLEdBQUcsS0FBS0gsUUFBTCxDQUFjSSxJQUFkLENBQW1CLFVBQUNDLE1BQUQsRUFBWTtBQUNuRCxZQUFNQyxVQUFVLEdBQUdELE1BQU0sQ0FBQ0UsT0FBUCxFQUFuQjs7QUFFQSxZ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eyBhcnJheVV0aWxpdGllcyB9IGZyb20gXCJuZWNlc3NhcnlcIjtcblxuaW1wb3J0IEN5Y2xlIGZyb20gXCIuL2dyYXBoL2N5Y2xlXCI7XG5pbXBvcnQgU3RhY2sgZnJvbSBcIi4vZ3JhcGgvc3RhY2tcIjtcbmltcG9ydCBWZXJ0ZXggZnJvbSBcIi4vZ3JhcGgvdmVydGV4XCI7XG5pbXBvcnQgU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQgZnJvbSBcIi4vZ3JhcGgvc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRcIjtcblxuY29uc3QgeyBmaXJzdCwgc2Vjb25kIH0gPSBhcnJheVV0aWxpdGllcztcblxuY2xhc3MgR3JhcGgge1xuICBjb25zdHJ1Y3RvciAoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLCB2ZXJ0aWNlcywgY3ljbGVzKSB7XG4gICAgdGhpcy5zdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHM7XG4gICAgdGhpcy52ZXJ0aWNlcyA9IHZlcnRpY2VzO1xuICAgIHRoaXMuY3ljbGVzID0gY3ljbGVzO1xuICB9XG5cbiAgZ2V0U3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKCkge1xuICAgIHJldHVybiB0aGlzLnN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cztcbiAgfVxuXG4gIGdldFZlcnRpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLnZlcnRpY2VzO1xuICB9XG5cbiAgZ2V0Q3ljbGVzKCkge1xuICAgIHJldHVybiB0aGlzLmN5Y2xlcztcbiAgfVxuICBcbiAgaXNWZXJ0ZXhQcmVzZW50KG5hbWUpIHtcbiAgICBjb25zdCB2ZXJ0ZXhQcmVzZW50ID0gdGhpcy52ZXJ0aWNlcy5zb21lKCh2ZXJ0ZXgpID0+IHtcbiAgICAgIGNvbnN0IHZlcnRleE5hbWUgPSB2ZXJ0ZXguZ2V0TmFtZSgpO1xuICAgICAgXG4gICAgICBpZiAodmVydGV4TmFtZSA9PT0gbmFtZSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB2ZXJ0ZXhQcmVzZW50O1xuICB9XG5cbiAgc3RhdGljIGZyb21WZXJ0ZXhMaXRlcmFscyh2ZXJ0ZXhMaXRlcmFscykge1xuICAgIGNvbnN0IHZlcnRleE1hcCA9IHZlcnRleExpdGVyYWxzLnJlZHVjZSgodmVydGV4TWFwLCB2ZXJ0ZXhMaXRlcmFsKSA9PiB7XG4gICAgICAgICAgICBhZGRWZXJ0ZXhMaXRlcmFsKHZlcnRleE1hcCwgdmVydGV4TGl0ZXJhbCk7ICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB2ZXJ0ZXhNYXA7XG4gICAgICAgICAgfSwge30pLFxuICAgICAgICAgIHZlcnRpY2VzID0gdmVydGljZXNGcm9tVmVydGV4TWFwKHZlcnRleE1hcCksXG4gICAgICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzRnJvbVZlcnRpY2VzKHZlcnRpY2VzKSxcbiAgICAgICAgICBjeWNsZXMgPSBjeWNsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLCB2ZXJ0aWNlcywgY3ljbGVzKTtcbiAgICBcbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBHcmFwaDtcblxuZnVuY3Rpb24gYWRkVmVydGV4TGl0ZXJhbCh2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGZpcnN0KHZlcnRleExpdGVyYWwpLFxuICAgICAgICBzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IHNlY29uZCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgdmVydGV4TmFtZSA9IGZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQsIC8vL1xuICAgICAgICBkZXNjZW5kYW50VmVydGV4TmFtZXMgPSBzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudDsgLy8vXG5cbiAgbGV0IHN1Y2Nlc3NvclZlcnRpY2VzID0gZGVzY2VuZGFudFZlcnRleE5hbWVzLm1hcCgoZGVzY2VuZGFudFZlcnRleE5hbWUpID0+IHtcbiAgICBsZXQgc3VjY2Vzc29yVmVydGV4O1xuXG4gICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4TmFtZSA9IGRlc2NlbmRhbnRWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgc3VjY2Vzc29yVmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KHN1Y2Nlc3NvclZlcnRleE5hbWUpO1xuXG4gICAgaWYgKHN1Y2Nlc3NvclZlcnRleEV4aXN0cykge1xuICAgICAgc3VjY2Vzc29yVmVydGV4ID0gdmVydGV4TWFwW3N1Y2Nlc3NvclZlcnRleE5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWNjZXNzb3JWZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUoc3VjY2Vzc29yVmVydGV4TmFtZSk7XG5cbiAgICAgIHZlcnRleE1hcFtzdWNjZXNzb3JWZXJ0ZXhOYW1lXSA9IHN1Y2Nlc3NvclZlcnRleDtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VjY2Vzc29yVmVydGV4O1xuICB9KTtcblxuICBsZXQgdmVydGV4O1xuXG4gIGNvbnN0IHZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eSh2ZXJ0ZXhOYW1lKTtcblxuICBpZiAodmVydGV4RXhpc3RzKSB7XG4gICAgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdO1xuICB9IGVsc2Uge1xuICAgIHZlcnRleCA9IFZlcnRleC5mcm9tVmVydGV4TmFtZSh2ZXJ0ZXhOYW1lKTtcblxuICAgIHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXSA9IHZlcnRleDtcbiAgfVxuXG4gIHN1Y2Nlc3NvclZlcnRpY2VzID0gc3VjY2Vzc29yVmVydGljZXMuY29uY2F0KFtdKS5yZXZlcnNlKCk7IC8vL1xuXG4gIHZlcnRleC5zZXRTdWNjZXNzb3JWZXJ0aWNlcyhzdWNjZXNzb3JWZXJ0aWNlcyk7XG59XG5cbmZ1bmN0aW9uIHZlcnRpY2VzRnJvbVZlcnRleE1hcCh2ZXJ0ZXhNYXApIHtcbiAgY29uc3QgdmVydGV4TmFtZXMgPSBPYmplY3Qua2V5cyh2ZXJ0ZXhNYXApLFxuICAgICAgICB2ZXJ0aWNlcyA9IHZlcnRleE5hbWVzLm1hcCgodmVydGV4TmFtZSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHZlcnRleCA9IHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXTtcbiAgXG4gICAgICAgICAgcmV0dXJuIHZlcnRleDtcbiAgICAgICAgfSk7XG5cbiAgcmV0dXJuIHZlcnRpY2VzO1xufVxuXG5mdW5jdGlvbiBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHNGcm9tVmVydGljZXModmVydGljZXMpIHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKSxcbiAgICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gW107XG5cbiAgbGV0IGluZGV4ID0gMDtcblxuICBmdW5jdGlvbiBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgodmVydGV4KSB7XG4gICAgY29uc3QgbG93ZXN0SW5kZXggPSBpbmRleDsgIC8vL1xuXG4gICAgdmVydGV4LnNldEluZGV4KGluZGV4KTtcblxuICAgIHZlcnRleC5zZXRMb3dlc3RJbmRleChsb3dlc3RJbmRleCk7XG5cbiAgICBpbmRleCsrO1xuXG4gICAgc3RhY2sucHVzaCh2ZXJ0ZXgpO1xuXG4gICAgY29uc3Qgc3VjY2Vzc29yVmVydGljZXMgPSB2ZXJ0ZXguZ2V0U3VjY2Vzc29yVmVydGljZXMoKTtcblxuICAgIHN1Y2Nlc3NvclZlcnRpY2VzLmZvckVhY2goKHN1Y2Nlc3NvclZlcnRleCkgPT4ge1xuICAgICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4VW5pbmRleGVkID0gc3VjY2Vzc29yVmVydGV4LmlzVW5pbmRleGVkKCksXG4gICAgICAgICAgICBzdWNjZXNzb3JWZXJ0ZXhOb3RTdHJvbmdseUNvbm5lY3RlZCA9IHN1Y2Nlc3NvclZlcnRleFVuaW5kZXhlZDsgIC8vL1xuXG4gICAgICBpZiAoc3VjY2Vzc29yVmVydGV4Tm90U3Ryb25nbHlDb25uZWN0ZWQpIHtcbiAgICAgICAgc3Ryb25nbHlDb25uZWN0VmVydGV4KHN1Y2Nlc3NvclZlcnRleCk7XG5cbiAgICAgICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4TG93ZXN0SW5kZXggPSBzdWNjZXNzb3JWZXJ0ZXguZ2V0TG93ZXN0SW5kZXgoKTtcblxuICAgICAgICB2ZXJ0ZXgudXBkYXRlTG93ZXN0SW5kZXgoc3VjY2Vzc29yVmVydGV4TG93ZXN0SW5kZXgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4U3RhY2tlZCA9IHN1Y2Nlc3NvclZlcnRleC5pc1N0YWNrZWQoKTtcblxuICAgICAgICBpZiAoc3VjY2Vzc29yVmVydGV4U3RhY2tlZCkge1xuICAgICAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleEluZGV4ID0gc3VjY2Vzc29yVmVydGV4LmdldEluZGV4KCk7XG5cbiAgICAgICAgICB2ZXJ0ZXgudXBkYXRlTG93ZXN0SW5kZXgoc3VjY2Vzc29yVmVydGV4SW5kZXgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB2ZXJ0ZXhMb3dlc3QgPSB2ZXJ0ZXguaXNMb3dlc3QoKTtcblxuICAgIGlmICh2ZXJ0ZXhMb3dlc3QpIHtcbiAgICAgIGNvbnN0IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50ID0gU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQuZnJvbVN0YWNrQW5kVmVydGV4KHN0YWNrLCB2ZXJ0ZXgpO1xuXG4gICAgICBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMucHVzaChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCk7XG4gICAgfVxuICB9XG5cbiAgdmVydGljZXMuZm9yRWFjaCgodmVydGV4KSA9PiB7XG4gICAgY29uc3QgdmVydGV4VW5pbmRleGVkID0gdmVydGV4LmlzVW5pbmRleGVkKCk7XG5cbiAgICBpZiAodmVydGV4VW5pbmRleGVkKSB7XG4gICAgICBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgodmVydGV4KTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHM7XG59XG5cbmZ1bmN0aW9uIGN5Y2xlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKSB7XG4gIGNvbnN0IGN5Y2xlcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cy5yZWR1Y2UoKGN5Y2xlcywgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQpID0+IHtcbiAgICBjb25zdCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LmlzQ3ljbGljKCk7XG5cbiAgICBpZiAoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRDeWNsaWMpIHtcbiAgICAgIGNvbnN0IGN5Y2xlID0gQ3ljbGUuZnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KTtcblxuICAgICAgY3ljbGVzLnB1c2goY3ljbGUpO1xuICAgIH1cblxuICAgIHJldHVybiBjeWNsZXM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gY3ljbGVzO1xufVxuIl19