'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var necessary = require('necessary');

var Cycle = require('./graph/cycle'),
    Stack = require('./graph/stack'),
    Vertex = require('./graph/vertex'),
    StronglyConnectedComponent = require('./graph/stronglyConnectedComponent');

var array = necessary.array;

var Graph = function () {
  function Graph(vertices, stronglyConnectedComponents, cycles) {
    _classCallCheck(this, Graph);

    this.vertices = vertices;
    this.stronglyConnectedComponents = stronglyConnectedComponents;
    this.cycles = cycles;
  }

  _createClass(Graph, [{
    key: 'getVertices',
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: 'getStronglyConnectedComponents',
    value: function getStronglyConnectedComponents() {
      return this.stronglyConnectedComponents;
    }
  }, {
    key: 'getCycles',
    value: function getCycles() {
      return this.cycles;
    }
  }, {
    key: 'isVertexPresent',
    value: function isVertexPresent(name) {
      var vertexPresent = this.vertices.some(function (vertex) {
        var vertexName = vertex.getName();

        if (vertexName === name) {
          return true;
        }
      });

      return vertexPresent;
    }
  }], [{
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexLiterals.reduce(function (vertexMap, vertexLiteral) {
        addVertexLiteral(vertexMap, vertexLiteral);

        return vertexMap;
      }, {}),
          vertices = verticesFromVertexMap(vertexMap),
          stronglyConnectedComponents = stronglyConnectedComponentsFromVertices(vertices),
          cycles = cyclesFromStronglyConnectedComponents(stronglyConnectedComponents),
          graph = new Graph(vertices, stronglyConnectedComponents, cycles);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function addVertexLiteral(vertexMap, vertexLiteral) {
  var firstVertexLiteralElement = array.first(vertexLiteral),
      secondVertexLiteralElement = array.second(vertexLiteral),
      vertexName = firstVertexLiteralElement,
      ///
  descendantVertexNames = secondVertexLiteralElement; ///

  var successorVertices = descendantVertexNames.map(function (descendantVertexName) {
    var successorVertex = void 0;

    var successorVertexName = descendantVertexName,
        ///
    successorVertexExists = vertexMap.hasOwnProperty(successorVertexName);

    if (successorVertexExists) {
      successorVertex = vertexMap[successorVertexName];
    } else {
      successorVertex = Vertex.fromVertexName(successorVertexName);

      vertexMap[successorVertexName] = successorVertex;
    }

    return successorVertex;
  });

  var vertex = void 0;

  var vertexExists = vertexMap.hasOwnProperty(vertexName);

  if (vertexExists) {
    vertex = vertexMap[vertexName];
  } else {
    vertex = Vertex.fromVertexName(vertexName);

    vertexMap[vertexName] = vertex;
  }

  successorVertices = successorVertices.concat([]).reverse(); ///

  vertex.setSuccessorVertices(successorVertices);
}

function verticesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      vertices = vertexNames.map(function (vertexName) {
    var vertex = vertexMap[vertexName];

    return vertex;
  });

  return vertices;
}

function stronglyConnectedComponentsFromVertices(vertices) {
  var stack = new Stack(),
      stronglyConnectedComponents = [];

  var index = 0;

  function stronglyConnectVertex(vertex) {
    var lowestIndex = index; ///

    vertex.setIndex(index);

    vertex.setLowestIndex(lowestIndex);

    index++;

    stack.push(vertex);

    var successorVertices = vertex.getSuccessorVertices();

    successorVertices.forEach(function (successorVertex) {
      var successorVertexUnindexed = successorVertex.isUnindexed(),
          successorVertexNotStronglyConnected = successorVertexUnindexed; ///

      if (successorVertexNotStronglyConnected) {
        stronglyConnectVertex(successorVertex);

        var successorVertexLowestIndex = successorVertex.getLowestIndex();

        vertex.updateLowestIndex(successorVertexLowestIndex);
      } else {
        var successorVertexStacked = successorVertex.isStacked();

        if (successorVertexStacked) {
          var successorVertexIndex = successorVertex.getIndex();

          vertex.updateLowestIndex(successorVertexIndex);
        }
      }
    });

    var vertexLowest = vertex.isLowest();

    if (vertexLowest) {
      var stronglyConnectedComponent = StronglyConnectedComponent.fromStackAndVertex(stack, vertex);

      stronglyConnectedComponents.push(stronglyConnectedComponent);
    }
  }

  vertices.forEach(function (vertex) {
    var vertexUnindexed = vertex.isUnindexed();

    if (vertexUnindexed) {
      stronglyConnectVertex(vertex);
    }
  });

  return stronglyConnectedComponents;
}

function cyclesFromStronglyConnectedComponents(stronglyConnectedComponents) {
  var cycles = stronglyConnectedComponents.reduce(function (cycles, stronglyConnectedComponent) {
    var stronglyConnectedComponentCyclic = stronglyConnectedComponent.isCyclic();

    if (stronglyConnectedComponentCyclic) {
      var cycle = Cycle.fromStronglyConnectedComponent(stronglyConnectedComponent);

      cycles.push(cycle);
    }

    return cycles;
  }, []);

  return cycles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJuZWNlc3NhcnkiLCJyZXF1aXJlIiwiQ3ljbGUiLCJTdGFjayIsIlZlcnRleCIsIlN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiYXJyYXkiLCJHcmFwaCIsInZlcnRpY2VzIiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzIiwiY3ljbGVzIiwibmFtZSIsInZlcnRleFByZXNlbnQiLCJzb21lIiwidmVydGV4IiwidmVydGV4TmFtZSIsImdldE5hbWUiLCJ2ZXJ0ZXhMaXRlcmFscyIsInZlcnRleE1hcCIsInJlZHVjZSIsInZlcnRleExpdGVyYWwiLCJhZGRWZXJ0ZXhMaXRlcmFsIiwidmVydGljZXNGcm9tVmVydGV4TWFwIiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzRnJvbVZlcnRpY2VzIiwiY3ljbGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsImdyYXBoIiwibW9kdWxlIiwiZXhwb3J0cyIsImZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQiLCJmaXJzdCIsInNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50Iiwic2Vjb25kIiwiZGVzY2VuZGFudFZlcnRleE5hbWVzIiwic3VjY2Vzc29yVmVydGljZXMiLCJtYXAiLCJkZXNjZW5kYW50VmVydGV4TmFtZSIsInN1Y2Nlc3NvclZlcnRleCIsInN1Y2Nlc3NvclZlcnRleE5hbWUiLCJzdWNjZXNzb3JWZXJ0ZXhFeGlzdHMiLCJoYXNPd25Qcm9wZXJ0eSIsImZyb21WZXJ0ZXhOYW1lIiwidmVydGV4RXhpc3RzIiwiY29uY2F0IiwicmV2ZXJzZSIsInNldFN1Y2Nlc3NvclZlcnRpY2VzIiwidmVydGV4TmFtZXMiLCJPYmplY3QiLCJrZXlzIiwic3RhY2siLCJpbmRleCIsInN0cm9uZ2x5Q29ubmVjdFZlcnRleCIsImxvd2VzdEluZGV4Iiwic2V0SW5kZXgiLCJzZXRMb3dlc3RJbmRleCIsInB1c2giLCJnZXRTdWNjZXNzb3JWZXJ0aWNlcyIsImZvckVhY2giLCJzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQiLCJpc1VuaW5kZXhlZCIsInN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkIiwic3VjY2Vzc29yVmVydGV4TG93ZXN0SW5kZXgiLCJnZXRMb3dlc3RJbmRleCIsInVwZGF0ZUxvd2VzdEluZGV4Iiwic3VjY2Vzc29yVmVydGV4U3RhY2tlZCIsImlzU3RhY2tlZCIsInN1Y2Nlc3NvclZlcnRleEluZGV4IiwiZ2V0SW5kZXgiLCJ2ZXJ0ZXhMb3dlc3QiLCJpc0xvd2VzdCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiZnJvbVN0YWNrQW5kVmVydGV4IiwidmVydGV4VW5pbmRleGVkIiwic3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRDeWNsaWMiLCJpc0N5Y2xpYyIsImN5Y2xlIiwiZnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsWUFBWUMsUUFBUSxXQUFSLENBQWxCOztBQUVBLElBQU1DLFFBQVFELFFBQVEsZUFBUixDQUFkO0FBQUEsSUFDTUUsUUFBUUYsUUFBUSxlQUFSLENBRGQ7QUFBQSxJQUVNRyxTQUFTSCxRQUFRLGdCQUFSLENBRmY7QUFBQSxJQUdNSSw2QkFBNkJKLFFBQVEsb0NBQVIsQ0FIbkM7O0lBS1FLLEssR0FBVU4sUyxDQUFWTSxLOztJQUVGQyxLO0FBQ0osaUJBQWFDLFFBQWIsRUFBdUJDLDJCQUF2QixFQUFvREMsTUFBcEQsRUFBNEQ7QUFBQTs7QUFDMUQsU0FBS0YsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQywyQkFBTCxHQUFtQ0EsMkJBQW5DO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBQ0Q7Ozs7a0NBRWE7QUFDWixhQUFPLEtBQUtGLFFBQVo7QUFDRDs7O3FEQUVnQztBQUMvQixhQUFPLEtBQUtDLDJCQUFaO0FBQ0Q7OztnQ0FFVztBQUNWLGFBQU8sS0FBS0MsTUFBWjtBQUNEOzs7b0NBRWVDLEksRUFBTTtBQUNwQixVQUFNQyxnQkFBZ0IsS0FBS0osUUFBTCxDQUFjSyxJQUFkLENBQW1CLFVBQVNDLE1BQVQsRUFBaUI7QUFDeEQsWUFBTUMsYUFBYUQsT0FBT0UsT0FBUCxFQUFuQjs7QUFFQSxZQUFJRCxlQUFlSixJQUFuQixFQUF5QjtBQUN2QixpQkFBTyxJQUFQO0FBQ0Q7QUFDRixPQU5xQixDQUF0Qjs7QUFRQSxhQUFPQyxhQUFQO0FBQ0Q7Ozt1Q0FFeUJLLGMsRUFBZ0I7QUFDeEMsVUFBTUMsWUFBWUQsZUFBZUUsTUFBZixDQUFzQixVQUFTRCxTQUFULEVBQW9CRSxhQUFwQixFQUFtQztBQUNuRUMseUJBQWlCSCxTQUFqQixFQUE0QkUsYUFBNUI7O0FBRUEsZUFBT0YsU0FBUDtBQUNELE9BSlcsRUFJVCxFQUpTLENBQWxCO0FBQUEsVUFLTVYsV0FBV2Msc0JBQXNCSixTQUF0QixDQUxqQjtBQUFBLFVBTU1ULDhCQUE4QmMsd0NBQXdDZixRQUF4QyxDQU5wQztBQUFBLFVBT01FLFNBQVNjLHNDQUFzQ2YsMkJBQXRDLENBUGY7QUFBQSxVQVFNZ0IsUUFBUSxJQUFJbEIsS0FBSixDQUFVQyxRQUFWLEVBQW9CQywyQkFBcEIsRUFBaURDLE1BQWpELENBUmQ7O0FBVUEsYUFBT2UsS0FBUDtBQUNEOzs7Ozs7QUFHSEMsT0FBT0MsT0FBUCxHQUFpQnBCLEtBQWpCOztBQUVBLFNBQVNjLGdCQUFULENBQTBCSCxTQUExQixFQUFxQ0UsYUFBckMsRUFBb0Q7QUFDbEQsTUFBTVEsNEJBQTRCdEIsTUFBTXVCLEtBQU4sQ0FBWVQsYUFBWixDQUFsQztBQUFBLE1BQ01VLDZCQUE2QnhCLE1BQU15QixNQUFOLENBQWFYLGFBQWIsQ0FEbkM7QUFBQSxNQUVNTCxhQUFhYSx5QkFGbkI7QUFBQSxNQUU4QztBQUN4Q0ksMEJBQXdCRiwwQkFIOUIsQ0FEa0QsQ0FJUTs7QUFFMUQsTUFBSUcsb0JBQW9CRCxzQkFBc0JFLEdBQXRCLENBQTBCLFVBQVNDLG9CQUFULEVBQStCO0FBQy9FLFFBQUlDLHdCQUFKOztBQUVBLFFBQU1DLHNCQUFzQkYsb0JBQTVCO0FBQUEsUUFBbUQ7QUFDN0NHLDRCQUF3QnBCLFVBQVVxQixjQUFWLENBQXlCRixtQkFBekIsQ0FEOUI7O0FBR0EsUUFBSUMscUJBQUosRUFBMkI7QUFDekJGLHdCQUFrQmxCLFVBQVVtQixtQkFBVixDQUFsQjtBQUNELEtBRkQsTUFFTztBQUNMRCx3QkFBa0JoQyxPQUFPb0MsY0FBUCxDQUFzQkgsbUJBQXRCLENBQWxCOztBQUVBbkIsZ0JBQVVtQixtQkFBVixJQUFpQ0QsZUFBakM7QUFDRDs7QUFFRCxXQUFPQSxlQUFQO0FBQ0QsR0FmdUIsQ0FBeEI7O0FBaUJBLE1BQUl0QixlQUFKOztBQUVBLE1BQU0yQixlQUFldkIsVUFBVXFCLGNBQVYsQ0FBeUJ4QixVQUF6QixDQUFyQjs7QUFFQSxNQUFJMEIsWUFBSixFQUFrQjtBQUNoQjNCLGFBQVNJLFVBQVVILFVBQVYsQ0FBVDtBQUNELEdBRkQsTUFFTztBQUNMRCxhQUFTVixPQUFPb0MsY0FBUCxDQUFzQnpCLFVBQXRCLENBQVQ7O0FBRUFHLGNBQVVILFVBQVYsSUFBd0JELE1BQXhCO0FBQ0Q7O0FBRURtQixzQkFBb0JBLGtCQUFrQlMsTUFBbEIsQ0FBeUIsRUFBekIsRUFBNkJDLE9BQTdCLEVBQXBCLENBbkNrRCxDQW1DVTs7QUFFNUQ3QixTQUFPOEIsb0JBQVAsQ0FBNEJYLGlCQUE1QjtBQUNEOztBQUVELFNBQVNYLHFCQUFULENBQStCSixTQUEvQixFQUEwQztBQUN4QyxNQUFNMkIsY0FBY0MsT0FBT0MsSUFBUCxDQUFZN0IsU0FBWixDQUFwQjtBQUFBLE1BQ01WLFdBQVdxQyxZQUFZWCxHQUFaLENBQWdCLFVBQVNuQixVQUFULEVBQXFCO0FBQzlDLFFBQU1ELFNBQVNJLFVBQVVILFVBQVYsQ0FBZjs7QUFFQSxXQUFPRCxNQUFQO0FBQ0QsR0FKVSxDQURqQjs7QUFPQSxTQUFPTixRQUFQO0FBQ0Q7O0FBRUQsU0FBU2UsdUNBQVQsQ0FBaURmLFFBQWpELEVBQTJEO0FBQ3pELE1BQU13QyxRQUFRLElBQUk3QyxLQUFKLEVBQWQ7QUFBQSxNQUNNTSw4QkFBOEIsRUFEcEM7O0FBR0EsTUFBSXdDLFFBQVEsQ0FBWjs7QUFFQSxXQUFTQyxxQkFBVCxDQUErQnBDLE1BQS9CLEVBQXVDO0FBQ3JDLFFBQU1xQyxjQUFjRixLQUFwQixDQURxQyxDQUNUOztBQUU1Qm5DLFdBQU9zQyxRQUFQLENBQWdCSCxLQUFoQjs7QUFFQW5DLFdBQU91QyxjQUFQLENBQXNCRixXQUF0Qjs7QUFFQUY7O0FBRUFELFVBQU1NLElBQU4sQ0FBV3hDLE1BQVg7O0FBRUEsUUFBTW1CLG9CQUFvQm5CLE9BQU95QyxvQkFBUCxFQUExQjs7QUFFQXRCLHNCQUFrQnVCLE9BQWxCLENBQTBCLFVBQVNwQixlQUFULEVBQTBCO0FBQ2xELFVBQU1xQiwyQkFBMkJyQixnQkFBZ0JzQixXQUFoQixFQUFqQztBQUFBLFVBQ01DLHNDQUFzQ0Ysd0JBRDVDLENBRGtELENBRXFCOztBQUV2RSxVQUFJRSxtQ0FBSixFQUF5QztBQUN2Q1QsOEJBQXNCZCxlQUF0Qjs7QUFFQSxZQUFNd0IsNkJBQTZCeEIsZ0JBQWdCeUIsY0FBaEIsRUFBbkM7O0FBRUEvQyxlQUFPZ0QsaUJBQVAsQ0FBeUJGLDBCQUF6QjtBQUNELE9BTkQsTUFNTztBQUNMLFlBQU1HLHlCQUF5QjNCLGdCQUFnQjRCLFNBQWhCLEVBQS9COztBQUVBLFlBQUlELHNCQUFKLEVBQTRCO0FBQzFCLGNBQU1FLHVCQUF1QjdCLGdCQUFnQjhCLFFBQWhCLEVBQTdCOztBQUVBcEQsaUJBQU9nRCxpQkFBUCxDQUF5Qkcsb0JBQXpCO0FBQ0Q7QUFDRjtBQUNGLEtBbkJEOztBQXFCQSxRQUFNRSxlQUFlckQsT0FBT3NELFFBQVAsRUFBckI7O0FBRUEsUUFBSUQsWUFBSixFQUFrQjtBQUNoQixVQUFNRSw2QkFBNkJoRSwyQkFBMkJpRSxrQkFBM0IsQ0FBOEN0QixLQUE5QyxFQUFxRGxDLE1BQXJELENBQW5DOztBQUVBTCxrQ0FBNEI2QyxJQUE1QixDQUFpQ2UsMEJBQWpDO0FBQ0Q7QUFDRjs7QUFFRDdELFdBQVNnRCxPQUFULENBQWlCLFVBQVMxQyxNQUFULEVBQWlCO0FBQ2hDLFFBQU15RCxrQkFBa0J6RCxPQUFPNEMsV0FBUCxFQUF4Qjs7QUFFQSxRQUFJYSxlQUFKLEVBQXFCO0FBQ25CckIsNEJBQXNCcEMsTUFBdEI7QUFDRDtBQUNGLEdBTkQ7O0FBUUEsU0FBT0wsMkJBQVA7QUFDRDs7QUFFRCxTQUFTZSxxQ0FBVCxDQUErQ2YsMkJBQS9DLEVBQTRFO0FBQzFFLE1BQU1DLFNBQVNELDRCQUE0QlUsTUFBNUIsQ0FBbUMsVUFBU1QsTUFBVCxFQUFpQjJELDBCQUFqQixFQUE2QztBQUM3RixRQUFNRyxtQ0FBbUNILDJCQUEyQkksUUFBM0IsRUFBekM7O0FBRUEsUUFBSUQsZ0NBQUosRUFBc0M7QUFDcEMsVUFBTUUsUUFBUXhFLE1BQU15RSw4QkFBTixDQUFxQ04sMEJBQXJDLENBQWQ7O0FBRUEzRCxhQUFPNEMsSUFBUCxDQUFZb0IsS0FBWjtBQUNEOztBQUVELFdBQU9oRSxNQUFQO0FBQ0QsR0FWYyxFQVVaLEVBVlksQ0FBZjs7QUFZQSxTQUFPQSxNQUFQO0FBQ0QiLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBDeWNsZSA9IHJlcXVpcmUoJy4vZ3JhcGgvY3ljbGUnKSxcbiAgICAgIFN0YWNrID0gcmVxdWlyZSgnLi9ncmFwaC9zdGFjaycpLFxuICAgICAgVmVydGV4ID0gcmVxdWlyZSgnLi9ncmFwaC92ZXJ0ZXgnKSxcbiAgICAgIFN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50ID0gcmVxdWlyZSgnLi9ncmFwaC9zdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCcpO1xuXG5jb25zdCB7IGFycmF5IH0gPSBuZWNlc3Nhcnk7XG5cbmNsYXNzIEdyYXBoIHtcbiAgY29uc3RydWN0b3IgKHZlcnRpY2VzLCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMsIGN5Y2xlcykge1xuICAgIHRoaXMudmVydGljZXMgPSB2ZXJ0aWNlcztcbiAgICB0aGlzLnN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cztcbiAgICB0aGlzLmN5Y2xlcyA9IGN5Y2xlcztcbiAgfVxuXG4gIGdldFZlcnRpY2VzKCkge1xuICAgIHJldHVybiB0aGlzLnZlcnRpY2VzO1xuICB9XG5cbiAgZ2V0U3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKCkge1xuICAgIHJldHVybiB0aGlzLnN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cztcbiAgfVxuICBcbiAgZ2V0Q3ljbGVzKCkge1xuICAgIHJldHVybiB0aGlzLmN5Y2xlcztcbiAgfVxuICBcbiAgaXNWZXJ0ZXhQcmVzZW50KG5hbWUpIHtcbiAgICBjb25zdCB2ZXJ0ZXhQcmVzZW50ID0gdGhpcy52ZXJ0aWNlcy5zb21lKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgICAgY29uc3QgdmVydGV4TmFtZSA9IHZlcnRleC5nZXROYW1lKCk7XG4gICAgICBcbiAgICAgIGlmICh2ZXJ0ZXhOYW1lID09PSBuYW1lKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHZlcnRleFByZXNlbnQ7XG4gIH1cblxuICBzdGF0aWMgZnJvbVZlcnRleExpdGVyYWxzKHZlcnRleExpdGVyYWxzKSB7XG4gICAgY29uc3QgdmVydGV4TWFwID0gdmVydGV4TGl0ZXJhbHMucmVkdWNlKGZ1bmN0aW9uKHZlcnRleE1hcCwgdmVydGV4TGl0ZXJhbCkge1xuICAgICAgICAgICAgYWRkVmVydGV4TGl0ZXJhbCh2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpOyAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdmVydGV4TWFwO1xuICAgICAgICAgIH0sIHt9KSxcbiAgICAgICAgICB2ZXJ0aWNlcyA9IHZlcnRpY2VzRnJvbVZlcnRleE1hcCh2ZXJ0ZXhNYXApLFxuICAgICAgICAgIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50c0Zyb21WZXJ0aWNlcyh2ZXJ0aWNlcyksXG4gICAgICAgICAgY3ljbGVzID0gY3ljbGVzRnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyhzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMpLFxuICAgICAgICAgIGdyYXBoID0gbmV3IEdyYXBoKHZlcnRpY2VzLCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMsIGN5Y2xlcyk7XG4gICAgXG4gICAgcmV0dXJuIGdyYXBoO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gR3JhcGg7XG5cbmZ1bmN0aW9uIGFkZFZlcnRleExpdGVyYWwodmVydGV4TWFwLCB2ZXJ0ZXhMaXRlcmFsKSB7XG4gIGNvbnN0IGZpcnN0VmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBhcnJheS5maXJzdCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBhcnJheS5zZWNvbmQodmVydGV4TGl0ZXJhbCksXG4gICAgICAgIHZlcnRleE5hbWUgPSBmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50LCAvLy9cbiAgICAgICAgZGVzY2VuZGFudFZlcnRleE5hbWVzID0gc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQ7IC8vL1xuXG4gIGxldCBzdWNjZXNzb3JWZXJ0aWNlcyA9IGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcy5tYXAoZnVuY3Rpb24oZGVzY2VuZGFudFZlcnRleE5hbWUpIHtcbiAgICBsZXQgc3VjY2Vzc29yVmVydGV4O1xuXG4gICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4TmFtZSA9IGRlc2NlbmRhbnRWZXJ0ZXhOYW1lLCAgLy8vXG4gICAgICAgICAgc3VjY2Vzc29yVmVydGV4RXhpc3RzID0gdmVydGV4TWFwLmhhc093blByb3BlcnR5KHN1Y2Nlc3NvclZlcnRleE5hbWUpO1xuXG4gICAgaWYgKHN1Y2Nlc3NvclZlcnRleEV4aXN0cykge1xuICAgICAgc3VjY2Vzc29yVmVydGV4ID0gdmVydGV4TWFwW3N1Y2Nlc3NvclZlcnRleE5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWNjZXNzb3JWZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUoc3VjY2Vzc29yVmVydGV4TmFtZSk7XG5cbiAgICAgIHZlcnRleE1hcFtzdWNjZXNzb3JWZXJ0ZXhOYW1lXSA9IHN1Y2Nlc3NvclZlcnRleDtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VjY2Vzc29yVmVydGV4O1xuICB9KTtcblxuICBsZXQgdmVydGV4O1xuXG4gIGNvbnN0IHZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eSh2ZXJ0ZXhOYW1lKTtcblxuICBpZiAodmVydGV4RXhpc3RzKSB7XG4gICAgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdO1xuICB9IGVsc2Uge1xuICAgIHZlcnRleCA9IFZlcnRleC5mcm9tVmVydGV4TmFtZSh2ZXJ0ZXhOYW1lKTtcblxuICAgIHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXSA9IHZlcnRleDtcbiAgfVxuXG4gIHN1Y2Nlc3NvclZlcnRpY2VzID0gc3VjY2Vzc29yVmVydGljZXMuY29uY2F0KFtdKS5yZXZlcnNlKCk7IC8vL1xuXG4gIHZlcnRleC5zZXRTdWNjZXNzb3JWZXJ0aWNlcyhzdWNjZXNzb3JWZXJ0aWNlcyk7XG59XG5cbmZ1bmN0aW9uIHZlcnRpY2VzRnJvbVZlcnRleE1hcCh2ZXJ0ZXhNYXApIHtcbiAgY29uc3QgdmVydGV4TmFtZXMgPSBPYmplY3Qua2V5cyh2ZXJ0ZXhNYXApLFxuICAgICAgICB2ZXJ0aWNlcyA9IHZlcnRleE5hbWVzLm1hcChmdW5jdGlvbih2ZXJ0ZXhOYW1lKSB7XG4gICAgICAgICAgY29uc3QgdmVydGV4ID0gdmVydGV4TWFwW3ZlcnRleE5hbWVdO1xuICBcbiAgICAgICAgICByZXR1cm4gdmVydGV4O1xuICAgICAgICB9KTtcblxuICByZXR1cm4gdmVydGljZXM7XG59XG5cbmZ1bmN0aW9uIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50c0Zyb21WZXJ0aWNlcyh2ZXJ0aWNlcykge1xuICBjb25zdCBzdGFjayA9IG5ldyBTdGFjaygpLFxuICAgICAgICBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMgPSBbXTtcblxuICBsZXQgaW5kZXggPSAwO1xuXG4gIGZ1bmN0aW9uIHN0cm9uZ2x5Q29ubmVjdFZlcnRleCh2ZXJ0ZXgpIHtcbiAgICBjb25zdCBsb3dlc3RJbmRleCA9IGluZGV4OyAgLy8vXG5cbiAgICB2ZXJ0ZXguc2V0SW5kZXgoaW5kZXgpO1xuXG4gICAgdmVydGV4LnNldExvd2VzdEluZGV4KGxvd2VzdEluZGV4KTtcblxuICAgIGluZGV4Kys7XG5cbiAgICBzdGFjay5wdXNoKHZlcnRleCk7XG5cbiAgICBjb25zdCBzdWNjZXNzb3JWZXJ0aWNlcyA9IHZlcnRleC5nZXRTdWNjZXNzb3JWZXJ0aWNlcygpO1xuXG4gICAgc3VjY2Vzc29yVmVydGljZXMuZm9yRWFjaChmdW5jdGlvbihzdWNjZXNzb3JWZXJ0ZXgpIHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleFVuaW5kZXhlZCA9IHN1Y2Nlc3NvclZlcnRleC5pc1VuaW5kZXhlZCgpLFxuICAgICAgICAgICAgc3VjY2Vzc29yVmVydGV4Tm90U3Ryb25nbHlDb25uZWN0ZWQgPSBzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQ7ICAvLy9cblxuICAgICAgaWYgKHN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkKSB7XG4gICAgICAgIHN0cm9uZ2x5Q29ubmVjdFZlcnRleChzdWNjZXNzb3JWZXJ0ZXgpO1xuXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleExvd2VzdEluZGV4ID0gc3VjY2Vzc29yVmVydGV4LmdldExvd2VzdEluZGV4KCk7XG5cbiAgICAgICAgdmVydGV4LnVwZGF0ZUxvd2VzdEluZGV4KHN1Y2Nlc3NvclZlcnRleExvd2VzdEluZGV4KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleFN0YWNrZWQgPSBzdWNjZXNzb3JWZXJ0ZXguaXNTdGFja2VkKCk7XG5cbiAgICAgICAgaWYgKHN1Y2Nlc3NvclZlcnRleFN0YWNrZWQpIHtcbiAgICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhJbmRleCA9IHN1Y2Nlc3NvclZlcnRleC5nZXRJbmRleCgpO1xuXG4gICAgICAgICAgdmVydGV4LnVwZGF0ZUxvd2VzdEluZGV4KHN1Y2Nlc3NvclZlcnRleEluZGV4KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgdmVydGV4TG93ZXN0ID0gdmVydGV4LmlzTG93ZXN0KCk7XG5cbiAgICBpZiAodmVydGV4TG93ZXN0KSB7XG4gICAgICBjb25zdCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCA9IFN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LmZyb21TdGFja0FuZFZlcnRleChzdGFjaywgdmVydGV4KTtcblxuICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzLnB1c2goc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQpO1xuICAgIH1cbiAgfVxuXG4gIHZlcnRpY2VzLmZvckVhY2goZnVuY3Rpb24odmVydGV4KSB7XG4gICAgY29uc3QgdmVydGV4VW5pbmRleGVkID0gdmVydGV4LmlzVW5pbmRleGVkKCk7XG5cbiAgICBpZiAodmVydGV4VW5pbmRleGVkKSB7XG4gICAgICBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgodmVydGV4KTtcbiAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHM7XG59XG5cbmZ1bmN0aW9uIGN5Y2xlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKSB7XG4gIGNvbnN0IGN5Y2xlcyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cy5yZWR1Y2UoZnVuY3Rpb24oY3ljbGVzLCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCkge1xuICAgIGNvbnN0IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Q3ljbGljID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQuaXNDeWNsaWMoKTtcblxuICAgIGlmIChzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYykge1xuICAgICAgY29uc3QgY3ljbGUgPSBDeWNsZS5mcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQpO1xuXG4gICAgICBjeWNsZXMucHVzaChjeWNsZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGN5Y2xlcztcbiAgfSwgW10pO1xuXG4gIHJldHVybiBjeWNsZXM7XG59XG4iXX0=