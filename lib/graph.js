'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Cycle = require('./graph/cycle'),
    Stack = require('./graph/stack'),
    Vertex = require('./graph/vertex'),
    StronglyConnectedComponent = require('./graph/stronglyConnectedComponent'),
    arrayUtil = require('./util/array');

var Graph = function () {
  function Graph(vertices, stronglyConnectedComponents, cycles) {
    _classCallCheck(this, Graph);

    this.vertices = vertices;
    this.stronglyConnectedComponents = stronglyConnectedComponents;
    this.cycles = cycles;
  }

  _createClass(Graph, [{
    key: 'getVertices',
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: 'getStronglyConnectedComponents',
    value: function getStronglyConnectedComponents() {
      return this.stronglyConnectedComponents;
    }
  }, {
    key: 'getCycles',
    value: function getCycles() {
      return this.cycles;
    }
  }, {
    key: 'isVertexPresent',
    value: function isVertexPresent(name) {
      var vertexPresent = this.vertices.some(function (vertex) {
        var vertexName = vertex.getName();

        if (vertexName === name) {
          return true;
        }
      });

      return vertexPresent;
    }
  }], [{
    key: 'fromVertexLiterals',
    value: function fromVertexLiterals(vertexLiterals) {
      var vertexMap = vertexLiterals.reduce(function (vertexMap, vertexLiteral) {
        addVertexLiteral(vertexMap, vertexLiteral);

        return vertexMap;
      }, {}),
          vertices = verticesFromVertexMap(vertexMap),
          stronglyConnectedComponents = stronglyConnectedComponentsFromVertices(vertices),
          cycles = cyclesFromStronglyConnectedComponents(stronglyConnectedComponents),
          graph = new Graph(vertices, stronglyConnectedComponents, cycles);

      return graph;
    }
  }]);

  return Graph;
}();

module.exports = Graph;

function addVertexLiteral(vertexMap, vertexLiteral) {
  var firstVertexLiteralElement = arrayUtil.first(vertexLiteral),
      secondVertexLiteralElement = arrayUtil.second(vertexLiteral),
      vertexName = firstVertexLiteralElement,
      ///
  descendantVertexNames = secondVertexLiteralElement; ///

  var successorVertices = descendantVertexNames.map(function (descendantVertexName) {
    var successorVertex = void 0;

    var successorVertexName = descendantVertexName,
        ///
    successorVertexExists = vertexMap.hasOwnProperty(successorVertexName);

    if (successorVertexExists) {
      successorVertex = vertexMap[successorVertexName];
    } else {
      successorVertex = Vertex.fromVertexName(successorVertexName);

      vertexMap[successorVertexName] = successorVertex;
    }

    return successorVertex;
  });

  var vertex = void 0;

  var vertexExists = vertexMap.hasOwnProperty(vertexName);

  if (vertexExists) {
    vertex = vertexMap[vertexName];
  } else {
    vertex = Vertex.fromVertexName(vertexName);

    vertexMap[vertexName] = vertex;
  }

  successorVertices = successorVertices.concat([]).reverse(); ///

  vertex.setSuccessorVertices(successorVertices);
}

function verticesFromVertexMap(vertexMap) {
  var vertexNames = Object.keys(vertexMap),
      vertices = vertexNames.map(function (vertexName) {
    var vertex = vertexMap[vertexName];

    return vertex;
  });

  return vertices;
}

function stronglyConnectedComponentsFromVertices(vertices) {
  var stack = new Stack(),
      stronglyConnectedComponents = [];

  var index = 0;

  function stronglyConnectVertex(vertex) {
    var lowestIndex = index; ///

    vertex.setIndex(index);

    vertex.setLowestIndex(lowestIndex);

    index++;

    stack.push(vertex);

    var successorVertices = vertex.getSuccessorVertices();

    successorVertices.forEach(function (successorVertex) {
      var successorVertexUnindexed = successorVertex.isUnindexed(),
          successorVertexNotStronglyConnected = successorVertexUnindexed; ///

      if (successorVertexNotStronglyConnected) {
        stronglyConnectVertex(successorVertex);

        var successorVertexLowestIndex = successorVertex.getLowestIndex();

        vertex.updateLowestIndex(successorVertexLowestIndex);
      } else {
        var successorVertexStacked = successorVertex.isStacked();

        if (successorVertexStacked) {
          var successorVertexIndex = successorVertex.getIndex();

          vertex.updateLowestIndex(successorVertexIndex);
        }
      }
    });

    var vertexLowest = vertex.isLowest();

    if (vertexLowest) {
      var stronglyConnectedComponent = StronglyConnectedComponent.fromStackAndVertex(stack, vertex);

      stronglyConnectedComponents.push(stronglyConnectedComponent);
    }
  }

  vertices.forEach(function (vertex) {
    var vertexUnindexed = vertex.isUnindexed();

    if (vertexUnindexed) {
      stronglyConnectVertex(vertex);
    }
  });

  return stronglyConnectedComponents;
}

function cyclesFromStronglyConnectedComponents(stronglyConnectedComponents) {
  var cycles = stronglyConnectedComponents.reduce(function (cycles, stronglyConnectedComponent) {
    var stronglyConnectedComponentCyclic = stronglyConnectedComponent.isCyclic();

    if (stronglyConnectedComponentCyclic) {
      var cycle = Cycle.fromStronglyConnectedComponent(stronglyConnectedComponent);

      cycles.push(cycle);
    }

    return cycles;
  }, []);

  return cycles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9ncmFwaC5qcyJdLCJuYW1lcyI6WyJDeWNsZSIsInJlcXVpcmUiLCJTdGFjayIsIlZlcnRleCIsIlN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50IiwiYXJyYXlVdGlsIiwiR3JhcGgiLCJ2ZXJ0aWNlcyIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyIsImN5Y2xlcyIsIm5hbWUiLCJ2ZXJ0ZXhQcmVzZW50Iiwic29tZSIsInZlcnRleCIsInZlcnRleE5hbWUiLCJnZXROYW1lIiwidmVydGV4TGl0ZXJhbHMiLCJ2ZXJ0ZXhNYXAiLCJyZWR1Y2UiLCJ2ZXJ0ZXhMaXRlcmFsIiwiYWRkVmVydGV4TGl0ZXJhbCIsInZlcnRpY2VzRnJvbVZlcnRleE1hcCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50c0Zyb21WZXJ0aWNlcyIsImN5Y2xlc0Zyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMiLCJncmFwaCIsIm1vZHVsZSIsImV4cG9ydHMiLCJmaXJzdFZlcnRleExpdGVyYWxFbGVtZW50IiwiZmlyc3QiLCJzZWNvbmRWZXJ0ZXhMaXRlcmFsRWxlbWVudCIsInNlY29uZCIsImRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyIsInN1Y2Nlc3NvclZlcnRpY2VzIiwibWFwIiwiZGVzY2VuZGFudFZlcnRleE5hbWUiLCJzdWNjZXNzb3JWZXJ0ZXgiLCJzdWNjZXNzb3JWZXJ0ZXhOYW1lIiwic3VjY2Vzc29yVmVydGV4RXhpc3RzIiwiaGFzT3duUHJvcGVydHkiLCJmcm9tVmVydGV4TmFtZSIsInZlcnRleEV4aXN0cyIsImNvbmNhdCIsInJldmVyc2UiLCJzZXRTdWNjZXNzb3JWZXJ0aWNlcyIsInZlcnRleE5hbWVzIiwiT2JqZWN0Iiwia2V5cyIsInN0YWNrIiwiaW5kZXgiLCJzdHJvbmdseUNvbm5lY3RWZXJ0ZXgiLCJsb3dlc3RJbmRleCIsInNldEluZGV4Iiwic2V0TG93ZXN0SW5kZXgiLCJwdXNoIiwiZ2V0U3VjY2Vzc29yVmVydGljZXMiLCJmb3JFYWNoIiwic3VjY2Vzc29yVmVydGV4VW5pbmRleGVkIiwiaXNVbmluZGV4ZWQiLCJzdWNjZXNzb3JWZXJ0ZXhOb3RTdHJvbmdseUNvbm5lY3RlZCIsInN1Y2Nlc3NvclZlcnRleExvd2VzdEluZGV4IiwiZ2V0TG93ZXN0SW5kZXgiLCJ1cGRhdGVMb3dlc3RJbmRleCIsInN1Y2Nlc3NvclZlcnRleFN0YWNrZWQiLCJpc1N0YWNrZWQiLCJzdWNjZXNzb3JWZXJ0ZXhJbmRleCIsImdldEluZGV4IiwidmVydGV4TG93ZXN0IiwiaXNMb3dlc3QiLCJzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCIsImZyb21TdGFja0FuZFZlcnRleCIsInZlcnRleFVuaW5kZXhlZCIsInN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50Q3ljbGljIiwiaXNDeWNsaWMiLCJjeWNsZSIsImZyb21TdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLFFBQVFDLFFBQVEsZUFBUixDQUFkO0FBQUEsSUFDTUMsUUFBUUQsUUFBUSxlQUFSLENBRGQ7QUFBQSxJQUVNRSxTQUFTRixRQUFRLGdCQUFSLENBRmY7QUFBQSxJQUdNRyw2QkFBNkJILFFBQVEsb0NBQVIsQ0FIbkM7QUFBQSxJQUlNSSxZQUFZSixRQUFRLGNBQVIsQ0FKbEI7O0lBTU1LLEs7QUFDSixpQkFBYUMsUUFBYixFQUF1QkMsMkJBQXZCLEVBQW9EQyxNQUFwRCxFQUE0RDtBQUFBOztBQUMxRCxTQUFLRixRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtDLDJCQUFMLEdBQW1DQSwyQkFBbkM7QUFDQSxTQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFDRDs7OztrQ0FFYTtBQUNaLGFBQU8sS0FBS0YsUUFBWjtBQUNEOzs7cURBRWdDO0FBQy9CLGFBQU8sS0FBS0MsMkJBQVo7QUFDRDs7O2dDQUVXO0FBQ1YsYUFBTyxLQUFLQyxNQUFaO0FBQ0Q7OztvQ0FFZUMsSSxFQUFNO0FBQ3BCLFVBQU1DLGdCQUFnQixLQUFLSixR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Q2hDLFFBQU15RCxrQkFBa0J6RCxPQUFPNEMsV0FBUCxFQUF4Qjs7QUFFQSxRQUFJYSxlQUFKLEVBQXFCO0FBQ25CckIsNEJBQXNCcEMsTUFBdEI7QUFDRDtBQUNGLEdBTkQ7O0FBUUEsU0FBT0wsMkJBQVA7QUFDRDs7QUFFRCxTQUFTZSxxQ0FBVCxDQUErQ2YsMkJBQS9DLEVBQTRFO0FBQzFFLE1BQU1DLFNBQVNELDRCQUE0QlUsTUFBNUIsQ0FBbUMsVUFBU1QsTUFBVCxFQUFpQjJELDBCQUFqQixFQUE2QztBQUM3RixRQUFNRyxtQ0FBbUNILDJCQUEyQkksUUFBM0IsRUFBekM7O0FBRUEsUUFBSUQsZ0NBQUosRUFBc0M7QUFDcEMsVUFBTUUsUUFBUXpFLE1BQU0wRSw4QkFBTixDQUFxQ04sMEJBQXJDLENBQWQ7O0FBRUEzRCxhQUFPNEMsSUFBUCxDQUFZb0IsS0FBWjtBQUNEOztBQUVELFdBQU9oRSxNQUFQO0FBQ0QsR0FWYyxFQVVaLEVBVlksQ0FBZjs7QUFZQSxTQUFPQSxNQUFQO0FBQ0QiLCJmaWxlIjoiZ3JhcGguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IEN5Y2xlID0gcmVxdWlyZSgnLi9ncmFwaC9jeWNsZScpLFxuICAgICAgU3RhY2sgPSByZXF1aXJlKCcuL2dyYXBoL3N0YWNrJyksXG4gICAgICBWZXJ0ZXggPSByZXF1aXJlKCcuL2dyYXBoL3ZlcnRleCcpLFxuICAgICAgU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQgPSByZXF1aXJlKCcuL2dyYXBoL3N0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50JyksXG4gICAgICBhcnJheVV0aWwgPSByZXF1aXJlKCcuL3V0aWwvYXJyYXknKTtcblxuY2xhc3MgR3JhcGgge1xuICBjb25zdHJ1Y3RvciAodmVydGljZXMsIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cywgY3ljbGVzKSB7XG4gICAgdGhpcy52ZXJ0aWNlcyA9IHZlcnRpY2VzO1xuICAgIHRoaXMuc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzO1xuICAgIHRoaXMuY3ljbGVzID0gY3ljbGVzO1xuICB9XG5cbiAgZ2V0VmVydGljZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMudmVydGljZXM7XG4gIH1cblxuICBnZXRTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzO1xuICB9XG4gIFxuICBnZXRDeWNsZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3ljbGVzO1xuICB9XG4gIFxuICBpc1ZlcnRleFByZXNlbnQobmFtZSkge1xuICAgIGNvbnN0IHZlcnRleFByZXNlbnQgPSB0aGlzLnZlcnRpY2VzLnNvbWUoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgICBjb25zdCB2ZXJ0ZXhOYW1lID0gdmVydGV4LmdldE5hbWUoKTtcbiAgICAgIFxuICAgICAgaWYgKHZlcnRleE5hbWUgPT09IG5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdmVydGV4UHJlc2VudDtcbiAgfVxuXG4gIHN0YXRpYyBmcm9tVmVydGV4TGl0ZXJhbHModmVydGV4TGl0ZXJhbHMpIHtcbiAgICBjb25zdCB2ZXJ0ZXhNYXAgPSB2ZXJ0ZXhMaXRlcmFscy5yZWR1Y2UoZnVuY3Rpb24odmVydGV4TWFwLCB2ZXJ0ZXhMaXRlcmFsKSB7XG4gICAgICAgICAgICBhZGRWZXJ0ZXhMaXRlcmFsKHZlcnRleE1hcCwgdmVydGV4TGl0ZXJhbCk7ICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB2ZXJ0ZXhNYXA7XG4gICAgICAgICAgfSwge30pLFxuICAgICAgICAgIHZlcnRpY2VzID0gdmVydGljZXNGcm9tVmVydGV4TWFwKHZlcnRleE1hcCksXG4gICAgICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzRnJvbVZlcnRpY2VzKHZlcnRpY2VzKSxcbiAgICAgICAgICBjeWNsZXMgPSBjeWNsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cyksXG4gICAgICAgICAgZ3JhcGggPSBuZXcgR3JhcGgodmVydGljZXMsIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cywgY3ljbGVzKTtcbiAgICBcbiAgICByZXR1cm4gZ3JhcGg7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBHcmFwaDtcblxuZnVuY3Rpb24gYWRkVmVydGV4TGl0ZXJhbCh2ZXJ0ZXhNYXAsIHZlcnRleExpdGVyYWwpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCA9IGFycmF5VXRpbC5maXJzdCh2ZXJ0ZXhMaXRlcmFsKSxcbiAgICAgICAgc2Vjb25kVmVydGV4TGl0ZXJhbEVsZW1lbnQgPSBhcnJheVV0aWwuc2Vjb25kKHZlcnRleExpdGVyYWwpLFxuICAgICAgICB2ZXJ0ZXhOYW1lID0gZmlyc3RWZXJ0ZXhMaXRlcmFsRWxlbWVudCwgLy8vXG4gICAgICAgIGRlc2NlbmRhbnRWZXJ0ZXhOYW1lcyA9IHNlY29uZFZlcnRleExpdGVyYWxFbGVtZW50OyAvLy9cblxuICBsZXQgc3VjY2Vzc29yVmVydGljZXMgPSBkZXNjZW5kYW50VmVydGV4TmFtZXMubWFwKGZ1bmN0aW9uKGRlc2NlbmRhbnRWZXJ0ZXhOYW1lKSB7XG4gICAgbGV0IHN1Y2Nlc3NvclZlcnRleDtcblxuICAgIGNvbnN0IHN1Y2Nlc3NvclZlcnRleE5hbWUgPSBkZXNjZW5kYW50VmVydGV4TmFtZSwgIC8vL1xuICAgICAgICAgIHN1Y2Nlc3NvclZlcnRleEV4aXN0cyA9IHZlcnRleE1hcC5oYXNPd25Qcm9wZXJ0eShzdWNjZXNzb3JWZXJ0ZXhOYW1lKTtcblxuICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhFeGlzdHMpIHtcbiAgICAgIHN1Y2Nlc3NvclZlcnRleCA9IHZlcnRleE1hcFtzdWNjZXNzb3JWZXJ0ZXhOYW1lXTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3VjY2Vzc29yVmVydGV4ID0gVmVydGV4LmZyb21WZXJ0ZXhOYW1lKHN1Y2Nlc3NvclZlcnRleE5hbWUpO1xuXG4gICAgICB2ZXJ0ZXhNYXBbc3VjY2Vzc29yVmVydGV4TmFtZV0gPSBzdWNjZXNzb3JWZXJ0ZXg7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1Y2Nlc3NvclZlcnRleDtcbiAgfSk7XG5cbiAgbGV0IHZlcnRleDtcblxuICBjb25zdCB2ZXJ0ZXhFeGlzdHMgPSB2ZXJ0ZXhNYXAuaGFzT3duUHJvcGVydHkodmVydGV4TmFtZSk7XG5cbiAgaWYgKHZlcnRleEV4aXN0cykge1xuICAgIHZlcnRleCA9IHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXTtcbiAgfSBlbHNlIHtcbiAgICB2ZXJ0ZXggPSBWZXJ0ZXguZnJvbVZlcnRleE5hbWUodmVydGV4TmFtZSk7XG5cbiAgICB2ZXJ0ZXhNYXBbdmVydGV4TmFtZV0gPSB2ZXJ0ZXg7XG4gIH1cblxuICBzdWNjZXNzb3JWZXJ0aWNlcyA9IHN1Y2Nlc3NvclZlcnRpY2VzLmNvbmNhdChbXSkucmV2ZXJzZSgpOyAvLy9cblxuICB2ZXJ0ZXguc2V0U3VjY2Vzc29yVmVydGljZXMoc3VjY2Vzc29yVmVydGljZXMpO1xufVxuXG5mdW5jdGlvbiB2ZXJ0aWNlc0Zyb21WZXJ0ZXhNYXAodmVydGV4TWFwKSB7XG4gIGNvbnN0IHZlcnRleE5hbWVzID0gT2JqZWN0LmtleXModmVydGV4TWFwKSxcbiAgICAgICAgdmVydGljZXMgPSB2ZXJ0ZXhOYW1lcy5tYXAoZnVuY3Rpb24odmVydGV4TmFtZSkge1xuICAgICAgICAgIGNvbnN0IHZlcnRleCA9IHZlcnRleE1hcFt2ZXJ0ZXhOYW1lXTtcbiAgXG4gICAgICAgICAgcmV0dXJuIHZlcnRleDtcbiAgICAgICAgfSk7XG5cbiAgcmV0dXJuIHZlcnRpY2VzO1xufVxuXG5mdW5jdGlvbiBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHNGcm9tVmVydGljZXModmVydGljZXMpIHtcbiAgY29uc3Qgc3RhY2sgPSBuZXcgU3RhY2soKSxcbiAgICAgICAgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzID0gW107XG5cbiAgbGV0IGluZGV4ID0gMDtcblxuICBmdW5jdGlvbiBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgodmVydGV4KSB7XG4gICAgY29uc3QgbG93ZXN0SW5kZXggPSBpbmRleDsgIC8vL1xuXG4gICAgdmVydGV4LnNldEluZGV4KGluZGV4KTtcblxuICAgIHZlcnRleC5zZXRMb3dlc3RJbmRleChsb3dlc3RJbmRleCk7XG5cbiAgICBpbmRleCsrO1xuXG4gICAgc3RhY2sucHVzaCh2ZXJ0ZXgpO1xuXG4gICAgY29uc3Qgc3VjY2Vzc29yVmVydGljZXMgPSB2ZXJ0ZXguZ2V0U3VjY2Vzc29yVmVydGljZXMoKTtcblxuICAgIHN1Y2Nlc3NvclZlcnRpY2VzLmZvckVhY2goZnVuY3Rpb24oc3VjY2Vzc29yVmVydGV4KSB7XG4gICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhVbmluZGV4ZWQgPSBzdWNjZXNzb3JWZXJ0ZXguaXNVbmluZGV4ZWQoKSxcbiAgICAgICAgICAgIHN1Y2Nlc3NvclZlcnRleE5vdFN0cm9uZ2x5Q29ubmVjdGVkID0gc3VjY2Vzc29yVmVydGV4VW5pbmRleGVkOyAgLy8vXG5cbiAgICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhOb3RTdHJvbmdseUNvbm5lY3RlZCkge1xuICAgICAgICBzdHJvbmdseUNvbm5lY3RWZXJ0ZXgoc3VjY2Vzc29yVmVydGV4KTtcblxuICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCA9IHN1Y2Nlc3NvclZlcnRleC5nZXRMb3dlc3RJbmRleCgpO1xuXG4gICAgICAgIHZlcnRleC51cGRhdGVMb3dlc3RJbmRleChzdWNjZXNzb3JWZXJ0ZXhMb3dlc3RJbmRleCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkID0gc3VjY2Vzc29yVmVydGV4LmlzU3RhY2tlZCgpO1xuXG4gICAgICAgIGlmIChzdWNjZXNzb3JWZXJ0ZXhTdGFja2VkKSB7XG4gICAgICAgICAgY29uc3Qgc3VjY2Vzc29yVmVydGV4SW5kZXggPSBzdWNjZXNzb3JWZXJ0ZXguZ2V0SW5kZXgoKTtcblxuICAgICAgICAgIHZlcnRleC51cGRhdGVMb3dlc3RJbmRleChzdWNjZXNzb3JWZXJ0ZXhJbmRleCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHZlcnRleExvd2VzdCA9IHZlcnRleC5pc0xvd2VzdCgpO1xuXG4gICAgaWYgKHZlcnRleExvd2VzdCkge1xuICAgICAgY29uc3Qgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQgPSBTdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudC5mcm9tU3RhY2tBbmRWZXJ0ZXgoc3RhY2ssIHZlcnRleCk7XG5cbiAgICAgIHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cy5wdXNoKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICB2ZXJ0aWNlcy5mb3JFYWNoKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgIGNvbnN0IHZlcnRleFVuaW5kZXhlZCA9IHZlcnRleC5pc1VuaW5kZXhlZCgpO1xuXG4gICAgaWYgKHZlcnRleFVuaW5kZXhlZCkge1xuICAgICAgc3Ryb25nbHlDb25uZWN0VmVydGV4KHZlcnRleCk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzO1xufVxuXG5mdW5jdGlvbiBjeWNsZXNGcm9tU3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRzKHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50cykge1xuICBjb25zdCBjeWNsZXMgPSBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudHMucmVkdWNlKGZ1bmN0aW9uKGN5Y2xlcywgc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnQpIHtcbiAgICBjb25zdCBzdHJvbmdseUNvbm5lY3RlZENvbXBvbmVudEN5Y2xpYyA9IHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50LmlzQ3ljbGljKCk7XG5cbiAgICBpZiAoc3Ryb25nbHlDb25uZWN0ZWRDb21wb25lbnRDeWNsaWMpIHtcbiAgICAgIGNvbnN0IGN5Y2xlID0gQ3ljbGUuZnJvbVN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KHN0cm9uZ2x5Q29ubmVjdGVkQ29tcG9uZW50KTtcblxuICAgICAgY3ljbGVzLnB1c2goY3ljbGUpO1xuICAgIH1cblxuICAgIHJldHVybiBjeWNsZXM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gY3ljbGVzO1xufVxuIl19